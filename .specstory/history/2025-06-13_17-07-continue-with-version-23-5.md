<!-- Generated by SpecStory -->

# Continue with version 23.5 (2025-06-13 13:07:18)

_**User**_

Please continue with subtask 23.5

---

_**Assistant**_



---



---

Here are the details for subtask 23.5:

‚Ä¢ ID: 23.5  
‚Ä¢ Title: Integrate Coverage Enforcement and CI Integration  
‚Ä¢ Status: in-progress  
‚Ä¢ Description: Configure Jest to enforce a minimum coverage threshold of >90% and integrate the unit tests into the existing CI environment so that the build fails if coverage drops below acceptable levels.  
‚Ä¢ Details:  
  ‚Äì Update the `jest.config.js` file with coverage threshold settings.  
  ‚Äì Modify CI/CD pipeline scripts to include test runs and enforce coverage checks.  
  ‚Äì Document integration steps and update testing utilities to avoid duplication.  
‚Ä¢ Test Strategy: Trigger a CI build with test runner and coverage enforcement enabled; verify the build fails upon coverage drops and passes when benchmarks are met.

Would you like to proceed with the implementation plan for this subtask (i.e., performing the initial exploration and logging the detailed plan)? If so, I can gather the specific files and propose the changes.

---

_**User**_

Yes, please proceed

---

_**Assistant**_



---

<details>
            <summary>Searched codebase "jest.config.js" ‚Ä¢ **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---



---

Read file: jest.config.js

---



---

<details>
            <summary>Listed directory scripts ‚Ä¢ **4** results</summary>
        
| Name |
|-------|
| üìÑ `create-toml-types.js` |
| üìÑ `validate-config.ts` |
| üìÑ `format-perf-report.js` |
| üìÑ `test-inspector.js` |

</details>

---



---

Read file: Dockerfile

---



---

Read file: package.json

---



---

Read file: README.md

---



---



---

I've logged the detailed exploration and plan for subtask 23.5, including the specific changes to `jest.config.js`, creating a GitHub Actions workflow, updating documentation, and validation steps. Let me know when you're ready to implement these changes or if you‚Äôd like adjustments to the plan.

---

_**User**_

I'm very ready!

---

_**Assistant**_



---

Read file: README.md

---



---

```diff
    detectOpenHandles: true, // Help identify unclosed handles
    coverageReporters: ['json', 'lcov', 'text', 'clover'],
+   coverageThreshold: {
+     global: {
+       branches: 90,
+       functions: 90,
+       lines: 90,
+       statements: 90,
+     },
+   },
    reporters: [
      'default',
```

---

```diff
+ name: CI Build and Test
+ on: [push, pull_request]
+ jobs:
+   test:
+     runs-on: ubuntu-latest
+     steps:
+       - uses: actions/checkout@v3
+       - uses: actions/setup-node@v3
+         with:
+           node-version: '18'
+       - run: npm ci
+       - run: npm run test:coverage
+ 
  name: CI
  
```

---



---

Read file: .github/workflows/ci.yml

---



---

I‚Äôve run into a snag: there‚Äôs already a fully-fledged `.github/workflows/ci.yml` in the repo, and my ‚Äúnew‚Äù workflow got merged in, resulting in duplicate `name`/`on`/`jobs` blocks and linter failures.

We have two main options:

1. **Integrate into the existing workflow**  
   - Remove the duplicate test job I just inserted  
   - In the existing `build_and_test` job, change the test step from `npm test` to `npm run test:coverage` so coverage thresholds (from `jest.config.js`) are enforced  

2. **Keep a separate coverage workflow**  
   - Delete or rename the existing workflow and isolate a new file just for coverage enforcement  
   - Or place a second distinct YAML file (e.g. `ci-coverage.yml`)  

Which approach would you prefer?

---

_**User**_

1 please

---

_**Assistant**_



---

```diff
- name: CI Build and Test
- on: [push, pull_request]
- jobs:
-   test:
-     runs-on: ubuntu-latest
-     steps:
-       - uses: actions/checkout@v3
-       - uses: actions/setup-node@v3
-         with:
-           node-version: '18'
-       - run: npm ci
-       - run: npm run test:coverage
- 
  name: CI
  
```

```diff
  
      - name: Run tests
-       run: npm test
+       run: npm run test:coverage
  
      - name: Publish Test Report
```

---



---

<details>
            <summary>Grep search for "CI Build and Test" ‚Ä¢ **0** files</summary>
        
No results found
</details>

---



---

<details>
            <summary>Grep search for "CI Build and Test" ‚Ä¢ **0** files</summary>
        
No results found
</details>

---



---

Read file: .github/workflows/ci.yml

---



---

```diff
  npm run test:coverage
  ```
+ 
+ ### Continuous Integration
+ 
+ In your CI (e.g., GitHub Actions), run:
+ 
+ ```bash
+ npm ci
+ npm run test:coverage
+ ```
+ 
+ Jest enforces a >90% coverage threshold via `jest.config.js`, causing the build to fail if coverage is below this level.
  
  ### Deployment
```

---

I‚Äôve updated the README with a **Continuous Integration** section under **Testing**, showing how to run coverage enforcement in CI. 

Next steps:
- Let me know if you‚Äôd like to run local tests to verify coverage enforcement.
- Otherwise, we can proceed to commit these changes.

---

_**User**_

Please continue with the local tests

---

_**Assistant**_

```bash
npm run test:coverage
```

```
‚ï∞‚îÄ ^[[200~npm run test:coverage^[[201~

‚ï≠‚îÄÓÇ≤ ÔÖπ ÓÇ± ÔÅº  ~/dev/projects/tally-mcp ÓÇ± ÔÑì  ÔÑ¶ develop ÓÇ¥¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑ÓÇ∂ ‚úî ÓÇ≥ 16:25:56 ÔÄó  ÓÇ∞
‚ï∞‚îÄ npm run tes
```

---

```bash
npm run test:coverage
```

```

> tally-mcp@1.0.0 test:coverage
> jest --coverage




 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts
npm run test:coverage

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/sse-connection-handshake.test.ts
 FAIL  src/__tests__/sse-connection-handshake.test.ts (38.225 s)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
  SSE Connection Establishment and MCP Handshake Testing

 RUNS  src/__tests__/sse-connection-handshake.test.ts
    Basic SSE Connection Establishment

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should establish SSE connection within expected timeframe (159 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle multiple simultaneous SSE connections (131 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should send initial connection confirmation message (110 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úï should maintain heartbeat mechanism (35178 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
    MCP Protocol Handshake

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should complete proper MCP initialization handshake (106 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should support capability negotiation (105 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle invalid handshake messages gracefully (106 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should validate JSON-RPC 2.0 compliance (106 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
    Tool Discovery Through SSE

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should list available tools correctly (114 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle tool calls with proper error handling (114 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
    Client Type Simulation

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle Claude Desktop simulation (110 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle MCP Inspector simulation (118 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle custom client simulation (111 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
    Connection State Management

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should track connection lifecycle properly (317 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle abrupt connection termination (611 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
    Performance and Reliability

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should establish connections within performance benchmarks (109 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts
      ‚úì should handle rapid connection cycling (128 ms)

 RUNS  src/__tests__/sse-connection-handshake.test.ts


 RUNS  src/__tests__/sse-connection-handshake.test.ts
  ‚óè SSE Connection Establishment and MCP Handshake Testing ‚Ä∫ Basic SSE Connection Establishment ‚Ä∫ should maintain 
heartbeat mechanism

    Event heartbeat not received within 35000ms

      137 |       await new Promise(resolve => setTimeout(resolve, 50));
      138 |     }
    > 139 |     throw new Error(`Event ${eventType} not received within ${timeout}ms`);
          |           ^
      140 |   }
      141 |
      142 |   on(event: string, listener: (...args: any[]) => void): void {

      at MockMCPClient.waitForEvent (src/__tests__/sse-connection-handshake.test.ts:139:11)
      at Object.<anonymous> (src/__tests__/sse-connection-handshake.test.ts:281:30)


 RUNS  src/__tests__/sse-connection-handshake.test.ts

 RUNS  src/__tests__/capability-negotiation.test.ts

 RUNS  src/__tests__/capability-negotiation.test.ts

 RUNS  src/__tests__/capability-negotiation.test.ts

 RUNS  src/__tests__/capability-negotiation.test.ts

 RUNS  src/__tests__/capability-negotiation.test.ts
 FAIL  src/__tests__/capability-negotiation.test.ts (15.403 s)
  ‚óè MCP Capability Negotiation ‚Ä∫ Protocol Version Negotiation ‚Ä∫ should reject unsupported protocol version

    expect(received).toBeDefined()

    Received: undefined

      197 |       });
      198 |
    > 199 |       expect(response.error).toBeDefined();
          |                              ^
      200 |       expect(response.error.code).toBe(-32600);
      201 |       expect(response.error.message).toContain('Unsupported protocol version');
      202 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:199:30)

  ‚óè MCP Capability Negotiation ‚Ä∫ Protocol Version Negotiation ‚Ä∫ should handle missing protocol version

    expect(received).toBeDefined()

    Received: undefined

      214 |       });
      215 |
    > 216 |       expect(response.error).toBeDefined();
          |                              ^
      217 |       expect(response.error.code).toBe(-32602);
      218 |       expect(response.error.message).toContain('Protocol version is required');
      219 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:216:30)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Discovery ‚Ä∫ should advertise supported capabilities in SSE connection

    Timeout waiting for event connection

       99 |     return new Promise((resolve, reject) => {
      100 |       const timeoutId = setTimeout(() => {
    > 101 |         reject(new Error(`Timeout waiting for event ${eventType}`));
          |                ^
      102 |       }, timeout);
      103 |
      104 |       const handler = (event: any) => {

      at Timeout._onTimeout (src/__tests__/capability-negotiation.test.ts:101:16)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should notify clients when tool list changes

    Unhandled error. (Error: SSE connection error

      53 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
      54 |         this.connected = false;
    > 55 |         const error = new Error('SSE connection error');
         |                       ^
      56 |         (error as any).event = errorEvent;
      57 |         this.events.push({ type: 'error', data: JSON.stringify(errorEvent) });
      58 |         this.eventEmitter.emit('error', error);

      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:55:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)
      at processTicksAndRejections (node:internal/process/task_queues:82:21) {
        event: Event { type: 'error', message: undefined }
      })
      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:58:27)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should notify clients when tool list changes

    Timeout waiting for event mcp-response

       99 |     return new Promise((resolve, reject) => {
      100 |       const timeoutId = setTimeout(() => {
    > 101 |         reject(new Error(`Timeout waiting for event ${eventType}`));
          |                ^
      102 |       }, timeout);
      103 |
      104 |       const handler = (event: any) => {

      at Timeout._onTimeout (src/__tests__/capability-negotiation.test.ts:101:16)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should maintain capability state across reconnections

    Unhandled error. (Error: SSE connection error

      53 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
      54 |         this.connected = false;
    > 55 |         const error = new Error('SSE connection error');
         |                       ^
      56 |         (error as any).event = errorEvent;
      57 |         this.events.push({ type: 'error', data: JSON.stringify(errorEvent) });
      58 |         this.eventEmitter.emit('error', error);

      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:55:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)
      at processTicksAndRejections (node:internal/process/task_queues:82:21) {
        event: Event { type: 'error', message: undefined }
      })
      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:58:27)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should maintain capability state across reconnections

    Timeout waiting for event connection

       99 |     return new Promise((resolve, reject) => {
      100 |       const timeoutId = setTimeout(() => {
    > 101 |         reject(new Error(`Timeout waiting for event ${eventType}`));
          |                ^
      102 |       }, timeout);
      103 |
      104 |       const handler = (event: any) => {

      at Timeout._onTimeout (src/__tests__/capability-negotiation.test.ts:101:16)

  ‚óè MCP Capability Negotiation ‚Ä∫ Error Handling ‚Ä∫ should handle malformed capability objects

    expect(received).toBeDefined()

    Received: undefined

      386 |       });
      387 |
    > 388 |       expect(response.error).toBeDefined();
          |                              ^
      389 |       expect(response.error.code).toBe(-32602);
      390 |       expect(response.error.message).toContain('Invalid capabilities format');
      391 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:388:30)

  ‚óè MCP Capability Negotiation ‚Ä∫ Error Handling ‚Ä∫ should handle invalid capability values

    expect(received).toBeDefined()

    Received: undefined

      408 |       });
      409 |
    > 410 |       expect(response.error).toBeDefined();
          |                              ^
      411 |       expect(response.error.code).toBe(-32602);
      412 |       expect(response.error.message).toContain('Invalid capability values');
      413 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:410:30)


  ‚óè Test suite failed to run

    Unhandled error. (Error: SSE connection error

      53 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
      54 |         this.connected = false;
    > 55 |         const error = new Error('SSE connection error');
         |                       ^
      56 |         (error as any).event = errorEvent;
      57 |         this.events.push({ type: 'error', data: JSON.stringify(errorEvent) });
      58 |         this.eventEmitter.emit('error', error);

      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:55:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)
      at processTicksAndRejections (node:internal/process/task_queues:82:21) {
        event: Event { type: 'error', message: undefined }
      })
      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:58:27)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)

 FAIL  src/utils/__tests__/crypto.test.ts (10.202 s)
  CryptoUtils
    API Key Generation and Validation
      ‚úì should generate an API key with default options (1 ms)
      ‚úì should generate an API key with a custom prefix and length (1 ms)
      ‚úì should throw an error for invalid key length (9 ms)
      ‚úì should validate a correctly formatted key
      ‚úì should invalidate a key with wrong prefix (1 ms)
      ‚úì should invalidate a key with wrong checksum
    Hashing
      ‚úì should hash an API key consistently (1 ms)
      ‚úì should hash with a salt (1 ms)
    Encryption and Decryption
      ‚úì should throw error if encryption key is missing
      ‚úì should encrypt and decrypt data successfully (1 ms)
      ‚úì should pad a short encryption key (1 ms)
      ‚úì should truncate a long encryption key (1 ms)
    HMAC Signature
      ‚úì should create and verify an HMAC signature
      ‚úì should fail verification for a wrong signature (1 ms)
      ‚úì should fail verification for wrong data
    Temporary Token
      ‚úì should generate and verify a temporary token (1 ms)
      ‚úì should fail verification for a tampered token (1 ms)
      ‚úï should fail verification for an expired token (10002 ms)
    Other Utilities
      ‚úì should generate a random salt (1 ms)
      ‚úì should generate a UUID (1 ms)
      ‚úï should mask sensitive data (3 ms)

  ‚óè CryptoUtils ‚Ä∫ Temporary Token ‚Ä∫ should fail verification for an expired token

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      150 |         setTimeout(() => {
      151 |             const result = CryptoUtils.verifyTempToken(token);
    > 152 |             expect(result.valid).toBe(false);
          |                                  ^
      153 |             expect(result.error).toBe('Token expired');
      154 |             done();
      155 |         }, 1100);

      at Timeout._onTimeout (src/utils/__tests__/crypto.test.ts:152:34)

  ‚óè CryptoUtils ‚Ä∫ Temporary Token ‚Ä∫ should fail verification for an expired token

    thrown: "Exceeded timeout of 10000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.i
o/docs/api#testname-fn-timeout."

      145 |     });
      146 |
    > 147 |     it('should fail verification for an expired token', (done) => {
          |     ^
      148 |         const payload = { userId: 'user-123' };
      149 |         const token = CryptoUtils.generateTempToken(payload, 1); // 1 second expiry
      150 |         setTimeout(() => {

      at src/utils/__tests__/crypto.test.ts:147:5
      at src/utils/__tests__/crypto.test.ts:125:3
      at Object.<anonymous> (src/utils/__tests__/crypto.test.ts:5:1)

  ‚óè CryptoUtils ‚Ä∫ Other Utilities ‚Ä∫ should mask sensitive data

    expect(received).toBe(expected) // Object.is equality

    Expected: "******7890"
    Received: "1234**7890"

      171 |     it('should mask sensitive data', () => {
      172 |         const sensitive = '1234567890';
    > 173 |         expect(CryptoUtils.maskSensitiveData(sensitive)).toBe('******7890');
          |                                                          ^
      174 |         expect(CryptoUtils.maskSensitiveData(sensitive, 2)).toBe('********90');
      175 |         expect(CryptoUtils.maskSensitiveData('abc')).toBe('abc');
      176 |     });

      at Object.<anonymous> (src/utils/__tests__/crypto.test.ts:173:58)

 FAIL  src/__tests__/message-delivery-formatting.test.ts
  Message Delivery and Formatting Verification
    SSE Message Format Validation
      ‚úì should establish SSE connection successfully (622 ms)
      ‚úì should format MCP response messages correctly (110 ms)
      ‚úì should handle various MCP method calls (109 ms)
      ‚úì should format error messages properly (113 ms)
    Message Timing and Delivery
      ‚úì should deliver messages within acceptable timeframe (109 ms)
      ‚úì should maintain message order for sequential requests (323 ms)
      ‚úì should handle concurrent message delivery (110 ms)
    Connection Stability
      ‚úì should maintain connection stability over time (1110 ms)
    Error Handling and Edge Cases
      ‚úï should handle malformed JSON in requests gracefully (111 ms)
      ‚úï should handle malformed JSON in responses (113 ms)
      ‚úï should handle requests without required fields (111 ms)
      ‚úì should handle non-existent methods (112 ms)
    Message Content Validation
      ‚úì should handle special characters and encoding (108 ms)
      ‚úì should validate JSON-RPC message structure compliance (106 ms)

  ‚óè Message Delivery and Formatting Verification ‚Ä∫ Error Handling and Edge Cases ‚Ä∫ should handle malformed JSON in
 requests gracefully

    SSE connection error

      54 |
      55 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
    > 56 |         const error = new Error('SSE connection error');
         |                       ^
      57 |         (error as any).event = errorEvent;
      58 |         this.connectionError = error;
      59 |         clearTimeout(timeoutId);

      at EventSource.eventSource.onerror (src/__tests__/message-delivery-formatting.test.ts:56:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at ClientRequest.<anonymous> (node_modules/eventsource/lib/eventsource.js:173:9)

  ‚óè Message Delivery and Formatting Verification ‚Ä∫ Error Handling and Edge Cases ‚Ä∫ should handle malformed JSON in
 responses

    SSE connection error

      54 |
      55 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
    > 56 |         const error = new Error('SSE connection error');
         |                       ^
      57 |         (error as any).event = errorEvent;
      58 |         this.connectionError = error;
      59 |         clearTimeout(timeoutId);

      at EventSource.eventSource.onerror (src/__tests__/message-delivery-formatting.test.ts:56:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at ClientRequest.<anonymous> (node_modules/eventsource/lib/eventsource.js:173:9)

  ‚óè Message Delivery and Formatting Verification ‚Ä∫ Error Handling and Edge Cases ‚Ä∫ should handle requests without 
required fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: undefined

      453 |         expect(true).toBe(false); // This should not be reached
      454 |       } catch (error: any) {
    > 455 |         expect(error.response?.status).toBe(400);
          |                                        ^
      456 |       }
      457 |     });
      458 |

      at Object.<anonymous> (src/__tests__/message-delivery-formatting.test.ts:455:40)

 FAIL  src/__tests__/TallyApiClient.test.ts
  TallyApiClient
    Constructor and Configuration
      ‚úì should create a client with default configuration (1 ms)
      ‚úì should create a client with custom configuration
      ‚úì should not set Authorization header if no access token is provided
    Access Token Management
      ‚úì should set access token and update Authorization header (2 ms)
      ‚úì should remove Authorization header when setting empty token (1 ms)
      ‚úì should return current access token
    HTTP Methods
      ‚úì should make a GET request (1 ms)
      ‚úì should make a GET request with custom config (1 ms)
      ‚úì should make a POST request with data
      ‚úì should make a PUT request with data (1 ms)
      ‚úì should make a DELETE request
      ‚úì should make a PATCH request with data (1 ms)
    Error Handling
      ‚úì should propagate axios errors (7 ms)
      ‚úì should propagate HTTP error responses (1 ms)
    Utility Methods
      ‚úì should return the axios instance (2 ms)
      ‚úì should return readonly configuration (1 ms)
    Interceptors
      ‚úì should always setup interceptors for authentication and error handling
      ‚úì should setup interceptors with debug logging when debug is enabled (1 ms)
    Type Safety
      ‚úì should maintain type safety with generic responses
    Rate Limiting and Retry Logic
      ‚úì should have retry configuration set correctly (1 ms)
      ‚úì should setup interceptors for retry logic (1 ms)
      ‚úì should handle custom retry configuration
    Type-Safe API Methods with Zod Validation
      getSubmissions
        ‚úï should validate and return submissions response (113 ms)
        ‚úï should throw validation error for invalid submissions response (102 ms)
      getForm
        ‚úï should validate and return form data (103 ms)
        ‚úï should throw validation error for invalid form response (103 ms)
      validateResponse
        ‚úì should return success result for valid data (2 ms)
        ‚úì should return error result for invalid data (1 ms)
      requestWithValidation
        ‚úì should make request and validate response with schema (1 ms)
        ‚úì should throw validation error for invalid response data (17 ms)

  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getSubmissions ‚Ä∫ should validate and return submi
ssions response

    expect(received).toEqual(expected) // deep equality

    - Expected  -   7
    + Received  + 204

    @@ -3,24 +3,221 @@
        "limit": 10,
        "page": 1,
        "questions": Array [],
        "submissions": Array [
          Object {
    -       "formId": "form_123",
    -       "id": "sub_1",
    +       "formId": "form_123456789",
    +       "id": "sub_000000001",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000001",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 1",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user1@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 1 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-12T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000002",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000002",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 2",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user2@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 2 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-11T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000003",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000003",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 3",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user3@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 3 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-10T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000004",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000004",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 4",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user4@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 4 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-09T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000005",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000005",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 5",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user5@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 5 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-08T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000006",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000006",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 6",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user6@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 6 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-07T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000007",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000007",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 7",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user7@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 7 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-06T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000008",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000008",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 8",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user8@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 8 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-05T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000009",
            "isCompleted": true,
    -       "respondentId": "resp_1",
    +       "respondentId": "resp_000000009",
            "responses": Array [
              Object {
                "questionId": "q1",
    -           "value": "Test User",
    +           "value": "User 9",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user9@example.com",
              },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 9 from a test user.",
    +         },
            ],
    -       "submittedAt": "2025-06-13T20:27:06.257Z",
    +       "submittedAt": "2025-06-04T20:27:06.364Z",
          },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000010",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000010",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 10",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user10@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 10 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-03T20:27:06.364Z",
    +     },
        ],
        "totalNumberOfSubmissionsPerFilter": Object {
    -     "all": 1,
    -     "completed": 1,
    +     "all": 10,
    +     "completed": 10,
          "partial": 0,
        },
      }

      479 |         const result = await client.getSubmissions('form123', { page: 1, limit: 10 });
      480 |
    > 481 |         expect(result).toEqual(validSubmissionsData);
          |                        ^
      482 |         expect(mockAxiosInstance.request).toHaveBeenCalledWith({
      483 |           method: 'GET',
      484 |           url: '/forms/form123/submissions?page=1&limit=10',

      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:481:24)

  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getSubmissions ‚Ä∫ should throw validation error fo
r invalid submissions response

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"hasMore": false, "limit": 10, "page": 1, "questions": [], "submissions": [{"formId": "for
m_123456789", "id": "sub_000000001", "isCompleted": true, "respondentId": "resp_000000001", "responses": [{"questi
onId": "q1", "value": "User 1"}, {"questionId": "q2", "value": "user1@example.com"}, {"questionId": "q3", "value":
 "This is message 1 from a test user."}], "submittedAt": "2025-06-12T20:27:06.471Z"}, {"formId": "form_123456789",
 "id": "sub_000000002", "isCompleted": true, "respondentId": "resp_000000002", "responses": [{"questionId": "q1",
"value": "User 2"}, {"questionId": "q2", "value": "user2@example.com"}, {"questionId": "q3", "value": "This is mes
sage 2 from a test user."}], "submittedAt": "2025-06-11T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_0
00000003", "isCompleted": true, "respondentId": "resp_000000003", "responses": [{"questionId": "q1", "value": "Use
r 3"}, {"questionId": "q2", "value": "user3@example.com"}, {"questionId": "q3", "value": "This is message 3 from a
 test user."}], "submittedAt": "2025-06-10T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000004", "i
sCompleted": true, "respondentId": "resp_000000004", "responses": [{"questionId": "q1", "value": "User 4"}, {"ques
tionId": "q2", "value": "user4@example.com"}, {"questionId": "q3", "value": "This is message 4 from a test user."}
], "submittedAt": "2025-06-09T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000005", "isCompleted":
true, "respondentId": "resp_000000005", "responses": [{"questionId": "q1", "value": "User 5"}, {"questionId": "q2"
, "value": "user5@example.com"}, {"questionId": "q3", "value": "This is message 5 from a test user."}], "submitted
At": "2025-06-08T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000006", "isCompleted": true, "respon
dentId": "resp_000000006", "responses": [{"questionId": "q1", "value": "User 6"}, {"questionId": "q2", "value": "u
ser6@example.com"}, {"questionId": "q3", "value": "This is message 6 from a test user."}], "submittedAt": "2025-06
-07T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000007", "isCompleted": true, "respondentId": "res
p_000000007", "responses": [{"questionId": "q1", "value": "User 7"}, {"questionId": "q2", "value": "user7@example.
com"}, {"questionId": "q3", "value": "This is message 7 from a test user."}], "submittedAt": "2025-06-06T20:27:06.
471Z"}, {"formId": "form_123456789", "id": "sub_000000008", "isCompleted": true, "respondentId": "resp_000000008",
 "responses": [{"questionId": "q1", "value": "User 8"}, {"questionId": "q2", "value": "user8@example.com"}, {"ques
tionId": "q3", "value": "This is message 8 from a test user."}], "submittedAt": "2025-06-05T20:27:06.471Z"}, {"for
mId": "form_123456789", "id": "sub_000000009", "isCompleted": true, "respondentId": "resp_000000009", "responses":
 [{"questionId": "q1", "value": "User 9"}, {"questionId": "q2", "value": "user9@example.com"}, {"questionId": "q3"
, "value": "This is message 9 from a test user."}], "submittedAt": "2025-06-04T20:27:06.471Z"}, {"formId": "form_1
23456789", "id": "sub_000000010", "isCompleted": true, "respondentId": "resp_000000010", "responses": [{"questionI
d": "q1", "value": "User 10"}, {"questionId": "q2", "value": "user10@example.com"}, {"questionId": "q3", "value":
"This is message 10 from a test user."}], "submittedAt": "2025-06-03T20:27:06.471Z"}], "totalNumberOfSubmissionsPe
rFilter": {"all": 10, "completed": 10, "partial": 0}}

      502 |         mockAxiosInstance.request.mockResolvedValue(mockResponse);
      503 |
    > 504 |         await expect(
          |               ^
      505 |           client.getSubmissions('form123', { page: 1, limit: 10 }),
      506 |         ).rejects.toThrow();
      507 |       });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:504:15)

  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getForm ‚Ä∫ should validate and return form data

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "createdAt": "2025-06-13T20:27:06.473Z",
    +   "createdAt": "2024-01-01T00:00:00Z",
        "description": "Get in touch with our team",
        "embedUrl": "https://tally.so/embed/form_123456789",
        "id": "form123",
        "isPublished": true,
        "status": "published",
        "submissionsCount": 42,
        "title": "Contact Us",
    -   "updatedAt": "2025-06-13T20:27:06.473Z",
    +   "updatedAt": "2024-01-01T00:00:00Z",
        "url": "https://tally.so/r/form_123456789",
      }

      537 |         const result = await client.getForm('form123');
      538 |
    > 539 |         expect(result).toEqual(validFormData);
          |                        ^
      540 |         expect(mockAxiosInstance.request).toHaveBeenCalledWith({
      541 |           method: 'GET',
      542 |           url: '/forms/form123',

      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:539:24)

  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getForm ‚Ä∫ should throw validation error for inval
id form response

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"createdAt": "2024-01-01T00:00:00Z", "description": "Get in touch with our team", "embedUr
l": "https://tally.so/embed/form_123456789", "id": "form123", "isPublished": true, "status": "published", "submiss
ionsCount": 42, "title": "Contact Us", "updatedAt": "2024-01-01T00:00:00Z", "url": "https://tally.so/r/form_123456
789"}

      560 |         mockAxiosInstance.request.mockResolvedValue(mockResponse);
      561 |
    > 562 |         await expect(client.getForm('form123')).rejects.toThrow();
          |               ^
      563 |       });
      564 |     });
      565 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:562:15)

 FAIL  src/middleware/__tests__/sanitization.test.ts
  Sanitization Middleware
    createSanitizationMiddleware
      ‚úï should sanitize body, query, and params by default (7 ms)
      ‚úì should use specified presets (2 ms)
      ‚úì should skip routes matching a pattern (1 ms)
      ‚úì should apply custom sanitizers (1 ms)
      ‚úï should handle nested objects (2 ms)
    Pre-configured SanitizationMiddleware
      ‚úï SanitizationMiddleware.apiParams should use strict sanitization (1 ms)
      ‚úï SanitizationMiddleware.formInput should allow some HTML (1 ms)
      ‚úï SanitizationMiddleware.richText should allow more formatting (3 ms)
    ManualSanitization
      ‚úï ManualSanitization.formData should sanitize object (2 ms)
      ‚úì ManualSanitization.apiResponse should sanitize strictly (2 ms)
      ‚úï ManualSanitization.logMessage should strip HTML and newlines (1 ms)

  ‚óè Sanitization Middleware ‚Ä∫ createSanitizationMiddleware ‚Ä∫ should sanitize body, query, and params by default

    expect(received).toBe(expected) // Object.is equality

    Expected: "alert(\"xss\")"
    Received: ""

      31 |       middleware(mockRequest as Request, mockResponse as Response, nextFunction);
      32 |
    > 33 |       expect(mockRequest.body.name).toBe('alert("xss")'); // Strips tags
         |                                     ^
      34 |       expect(mockRequest.body.email).toBe('test@test.com'); // Trims whitespace
      35 |       expect(mockRequest.query.search).toBe('&lt;p&gt;search term&lt;/p&gt;'); // Encodes HTML
      36 |       expect(mockRequest.params.id).toBe('123'); // Trims whitespace

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:33:37)

  ‚óè Sanitization Middleware ‚Ä∫ createSanitizationMiddleware ‚Ä∫ should handle nested objects

    expect(received).toBe(expected) // Object.is equality

    Expected: "&lt;p&gt;Test&lt;/p&gt;"
    Received: "  <p>Test</p>  "

      81 |         middleware(mockRequest as Request, mockResponse as Response, nextFunction);
      82 |
    > 83 |         expect(mockRequest.body.user.name).toBe('&lt;p&gt;Test&lt;/p&gt;');
         |                                            ^
      84 |         expect(nextFunction).toHaveBeenCalled();
      85 |     });
      86 |   });

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:83:44)

  ‚óè Sanitization Middleware ‚Ä∫ Pre-configured SanitizationMiddleware ‚Ä∫ SanitizationMiddleware.apiParams should use 
strict sanitization

    expect(received).toBe(expected) // Object.is equality

    Expected: "id"
    Received: ""

      90 |         mockRequest.body = { id: '<script>id</script>' };
      91 |         SanitizationMiddleware.apiParams(mockRequest as Request, mockResponse as Response, nextFunction
);
    > 92 |         expect(mockRequest.body.id).toBe('id');
         |                                     ^
      93 |     });
      94 |
      95 |     it('SanitizationMiddleware.formInput should allow some HTML', () => {

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:92:37)

  ‚óè Sanitization Middleware ‚Ä∫ Pre-configured SanitizationMiddleware ‚Ä∫ SanitizationMiddleware.formInput should allo
w some HTML

    expect(received).toBe(expected) // Object.is equality

    Expected: "<p>A nice comment.</p>bad"
    Received: "<p>A nice comment.</p>"

       96 |         mockRequest.body = { comment: '<p>A nice comment.</p><script>bad</script>' };
       97 |         SanitizationMiddleware.formInput(mockRequest as Request, mockResponse as Response, nextFunctio
n);
    >  98 |         expect(mockRequest.body.comment).toBe('<p>A nice comment.</p>bad');
          |                                          ^
       99 |     });
      100 |
      101 |     it('SanitizationMiddleware.richText should allow more formatting', () => {

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:98:42)

  ‚óè Sanitization Middleware ‚Ä∫ Pre-configured SanitizationMiddleware ‚Ä∫ SanitizationMiddleware.richText should allow
 more formatting

    expect(received).toBe(expected) // Object.is equality

    Expected: "<b>Bold</b> <a href=\"http://example.com\" rel=\"noopener noreferrer\">link</a>"
    Received: "<b>Bold</b> <a href=\"http://example.com\">link</a>"

      102 |         mockRequest.body = { article: '<b>Bold</b> <a href="http://example.com">link</a>' };
      103 |         SanitizationMiddleware.richText(mockRequest as Request, mockResponse as Response, nextFunction
);
    > 104 |         expect(mockRequest.body.article).toBe('<b>Bold</b> <a href="http://example.com" rel="noopener 
noreferrer">link</a>');
          |                                          ^
      105 |     });
      106 |   });
      107 |

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:104:42)

  ‚óè Sanitization Middleware ‚Ä∫ ManualSanitization ‚Ä∫ ManualSanitization.formData should sanitize object

    expect(received).toBe(expected) // Object.is equality

    Expected: "Name"
    Received: "<p>Name</p>"

      110 |         const dirty = { name: '<p>Name</p>', email: ' email@example.com ' };
      111 |         const clean = ManualSanitization.formData(dirty);
    > 112 |         expect(clean.name).toBe('Name');
          |                            ^
      113 |         expect(clean.email).toBe('email@example.com');
      114 |     });
      115 |

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:112:28)

  ‚óè Sanitization Middleware ‚Ä∫ ManualSanitization ‚Ä∫ ManualSanitization.logMessage should strip HTML and newlines

    expect(received).toBe(expected) // Object.is equality

    Expected: "Error: oops New line"
    Received: "Error:  New line"

      123 |         const dirty = 'Error: <script>oops</script>\nNew line';
      124 |         const clean = ManualSanitization.logMessage(dirty);
    > 125 |         expect(clean).toBe('Error: oops New line');
          |                       ^
      126 |     });
      127 |   });
      128 | }); 

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:125:23)

 FAIL  src/__tests__/health-check.test.ts
  Health Check Endpoint and Monitoring
    Health Metrics Collection
      ‚úì should collect comprehensive health metrics (14 ms)
      ‚úì should track uptime correctly (103 ms)
      ‚úì should report healthy status for running server (3 ms)
    Health Check Endpoint
      ‚úì should respond to /health endpoint with comprehensive metrics (2 ms)
      ‚úì should return 503 status when server is unhealthy (2 ms)
      ‚úì should handle health check errors gracefully (2 ms)
    Request Statistics Tracking
      ‚úï should track request counts (5 ms)
      ‚úì should track error counts (104 ms)
    Backward Compatibility
      ‚úì should maintain basic info endpoint at / (2 ms)
    System Resource Monitoring
      ‚úì should provide valid memory statistics (2 ms)
      ‚úì should provide valid CPU statistics (2 ms)
      ‚úì should provide valid system information (2 ms)

  ‚óè Health Check Endpoint and Monitoring ‚Ä∫ Request Statistics Tracking ‚Ä∫ should track request counts

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      189 |       
      190 |       const updatedMetrics = server.getHealthMetrics();
    > 191 |       expect(updatedMetrics.requests.total).toBeGreaterThan(initialTotal);
          |                                             ^
      192 |     });
      193 |
      194 |     test('should track error counts', async () => {

      at Object.<anonymous> (src/__tests__/health-check.test.ts:191:45)

 FAIL  src/middleware/__tests__/security.test.ts
  Security Middleware
    CORS Configuration
      ‚úì should handle preflight OPTIONS requests (16 ms)
      ‚úì should allow GET requests with CORS headers (6 ms)
      ‚úì should expose rate limit headers (8 ms)
    CORS with Environment Configuration
      ‚úì should allow requests from allowed origins (4 ms)
      ‚úì should reject requests from disallowed origins (4 ms)
    Security Headers
      ‚úì should set Content Security Policy header (6 ms)
      ‚úì should set HSTS header (4 ms)
      ‚úì should set X-Content-Type-Options header (4 ms)
      ‚úì should set X-Frame-Options header (6 ms)
      ‚úì should remove X-Powered-By header (4 ms)
      ‚úì should set Referrer-Policy header (5 ms)
    Custom Security Middleware
      ‚úì should set custom API version header (7 ms)
      ‚úì should set request ID header (4 ms)
      ‚úì should set no-cache headers for non-GET API endpoints (4 ms)
      ‚úì should add timing protection for auth endpoints (29 ms)
    Security Logger
      ‚úì should log security information for requests (5 ms)
    Security Validation
      ‚úì should allow normal requests (5 ms)
      ‚úï should block directory traversal attempts (4 ms)
      ‚úì should block XSS attempts in URL (5 ms)
      ‚úï should reject negative Content-Length (4 ms)
      ‚úì should reject oversized payloads (19 ms)
      ‚úï should warn about invalid User-Agent headers (5 ms)
      ‚úï should warn about oversized User-Agent headers (4 ms)
    Complete Security Middleware Stack
      ‚úì should block malicious requests even with full stack (5 ms)

  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should block directory traversal attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 200

      189 |     it('should block directory traversal attempts', async () => {
      190 |       const response = await request(app).get('/test/../../../etc/passwd');
    > 191 |       expect(response.status).toBe(400);
          |                               ^
      192 |       expect(response.body.code).toBe('SECURITY_VIOLATION');
      193 |     });
      194 |

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:191:31)

  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should reject negative Content-Length

    expect(received).toBe(expected) // Object.is equality

    Expected: "INVALID_CONTENT_LENGTH"
    Received: undefined

      205 |         .send({ data: 'test' });
      206 |       expect(response.status).toBe(400);
    > 207 |       expect(response.body.code).toBe('INVALID_CONTENT_LENGTH');
          |                                  ^
      208 |     });
      209 |
      210 |     it('should reject oversized payloads', async () => {

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:207:34)

  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should warn about invalid User-Agent headers

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Security Warning: Missing or empty User-Agent header."

    Number of calls: 0

      217 |     it('should warn about invalid User-Agent headers', async () => {
      218 |       await request(app).get('/test').set('User-Agent', '');
    > 219 |       expect(consoleWarnSpy).toHaveBeenCalledWith('Security Warning: Missing or empty User-Agent heade
r.');
          |                              ^
      220 |     });
      221 |
      222 |     it('should warn about oversized User-Agent headers', async () => {

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:219:30)

  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should warn about oversized User-Agent headers

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Security Warning: Oversized User-Agent header: 300 chars"

    Number of calls: 0

      222 |     it('should warn about oversized User-Agent headers', async () => {
      223 |       await request(app).get('/test').set('User-Agent', 'a'.repeat(300));
    > 224 |       expect(consoleWarnSpy).toHaveBeenCalledWith('Security Warning: Oversized User-Agent header: 300 
chars');
          |                              ^
      225 |     });
      226 |   });
      227 |

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:224:30)

 FAIL  src/services/__tests__/api-key-service.test.ts
  ApiKeyService
    createApiKey
      ‚úì should create a new API key with valid input (2 ms)
      ‚úì should create API key without optional fields (1 ms)
      ‚úì should throw error for invalid input (16 ms)
    validateApiKey
      ‚úì should validate a valid API key (1 ms)
      ‚úì should reject invalid API key format (1 ms)
      ‚úï should reject non-existent API key (1 ms)
      ‚úì should reject revoked API key (1 ms)
      ‚úì should reject expired API key (1 ms)
      ‚úì should reject key that exceeded usage limit (2 ms)
      ‚úì should reject IP not in whitelist (1 ms)
      ‚úì should accept IP in whitelist (1 ms)
    listApiKeys
      ‚úì should list all API keys
      ‚úì should filter by status (1 ms)
    updateApiKey
      ‚úì should update API key fields (1 ms)
      ‚úì should return null for non-existent key (3 ms)
    rotateApiKey
      ‚úì should rotate API key and return new key (1 ms)
      ‚úì should invalidate old key after rotation (1 ms)
      ‚úì should return null for non-existent key (1 ms)
    hasRequiredScopes
      ‚úì should return true for admin scope
      ‚úì should return true when all required scopes are present (1 ms)
      ‚úì should return false when required scopes are missing (1 ms)
    getApiKeyStats
      ‚úì should return correct statistics (1 ms)
    setupRotation
      ‚úì should setup rotation configuration (1 ms)
      ‚úì should return null for non-existent key (1 ms)
    getUsageLogs
      ‚úì should return usage logs for a key (1 ms)
      ‚úì should limit number of logs returned (1 ms)
  CryptoUtils
    generateApiKey
      ‚úì should generate API key with default options
      ‚úì should generate API key with custom options (1 ms)
      ‚úì should throw error for invalid length (5 ms)
    validateKeyFormat
      ‚úì should validate correct key format
      ‚úì should reject invalid key format (1 ms)
    hashApiKey
      ‚úì should generate consistent hash for same key
      ‚úì should generate different hashes for different keys
    maskSensitiveData
      ‚úì should mask data correctly
      ‚úì should handle short data

  ‚óè ApiKeyService ‚Ä∫ validateApiKey ‚Ä∫ should reject non-existent API key

    expect(received).toBe(expected) // Object.is equality

    Expected: "API key not found"
    Received: "Invalid API key format"

      135 |
      136 |       expect(result.isValid).toBe(false);
    > 137 |       expect(result.errorReason).toBe('API key not found');
          |                                  ^
      138 |     });
      139 |
      140 |     it('should reject revoked API key', async () => {

      at Object.<anonymous> (src/services/__tests__/api-key-service.test.ts:137:34)

 FAIL  src/tools/__tests__/form-sharing-tool.test.ts
  FormSharingTool
    constructor
      ‚úì should create an instance with FormPublicationService (2 ms)
    publishForm
      ‚úì should publish form successfully with minimal input (3 ms)
      ‚úì should publish form with all optional parameters (2 ms)
      ‚úì should handle publication errors (1 ms)
      ‚úì should handle unknown errors (1 ms)
      ‚úì should filter out undefined optional parameters (1 ms)
    unpublishForm
      ‚úì should unpublish form successfully
      ‚úì should handle unpublish errors (1 ms)
    getPublicationSettings
      ‚úì should get publication settings successfully (1 ms)
      ‚úì should handle get settings errors (1 ms)
    updatePublicationSettings
      ‚úï should update publication settings successfully (4 ms)
      ‚úï should filter out undefined values from settings (1 ms)
      ‚úì should handle update settings errors (1 ms)
    generateEmbedCode
      ‚úì should generate embed code successfully with minimal input (1 ms)
      ‚úì should generate embed code with all options (1 ms)
      ‚úì should handle embed code generation errors (1 ms)
    generateShareLink
      ‚úï should generate share link successfully (1 ms)
      ‚úï should generate share link with security options (1 ms)
      ‚úï should handle share link generation errors (1 ms)
    getShareLinks
      ‚úì should get share links successfully
      ‚úì should handle get share links errors (1 ms)
    deactivateShareLink
      ‚úì should deactivate share link successfully (1 ms)
      ‚úì should handle deactivate share link errors (2 ms)
    getFormSharingStats
      ‚úì should get sharing stats successfully (1 ms)
      ‚úì should handle get sharing stats errors (1 ms)
    getFormAnalytics
      ‚úì should get analytics with default period (1 ms)
      ‚úì should get analytics with custom period (1 ms)
      ‚úì should handle get analytics errors (1 ms)
    performBulkOperation
      ‚úì should perform bulk publish operation successfully (1 ms)
      ‚úì should perform bulk operation without settings (1 ms)
      ‚úì should handle bulk operation errors (1 ms)
    validateFormForPublication
      ‚úì should validate form successfully when form can be published
      ‚úì should validate form with validation issues
      ‚úì should handle validation errors (3 ms)
    edge cases and error handling
      ‚úï should handle empty form IDs array in bulk operation (1 ms)
      ‚úï should handle invalid email in notification emails (1 ms)
      ‚úï should handle invalid datetime in publish date (1 ms)

  ‚óè FormSharingTool ‚Ä∫ updatePublicationSettings ‚Ä∫ should update publication settings successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      "form-123",
      Object {
    -   "maxSubmissions": 100,
        "password": "newpassword",
        "visibility": "private",
      },

    Number of calls: 1

      310 |
      311 |       // Assert
    > 312 |       expect(mockPublicationService.updatePublicationSettings).toHaveBeenCalledWith('form-123', input.
settings);
          |                                                                ^
      313 |       expect(result).toEqual({
      314 |         success: true,
      315 |         data: updatedSettings,

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:312:64)

  ‚óè FormSharingTool ‚Ä∫ updatePublicationSettings ‚Ä∫ should filter out undefined values from settings

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      "form-123",
      Object {
    -   "maxSubmissions": 100,
        "visibility": "private",
      },

    Number of calls: 1

      336 |
      337 |       // Assert
    > 338 |       expect(mockPublicationService.updatePublicationSettings).toHaveBeenCalledWith('form-123', {
          |                                                                ^
      339 |         visibility: FormVisibility.PRIVATE,
      340 |         maxSubmissions: 100
      341 |       });

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:338:64)

  ‚óè FormSharingTool ‚Ä∫ generateShareLink ‚Ä∫ should generate share link successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "form-123", {"customSlug": "my-form", "type": undefined}

    Number of calls: 0

      449 |
      450 |       // Assert
    > 451 |       expect(mockPublicationService.generateShareLink).toHaveBeenCalledWith('form-123', {
          |                                                        ^
      452 |         type: ShareLinkType.DIRECT,
      453 |         customSlug: 'my-form'
      454 |       });

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:451:56)

  ‚óè FormSharingTool ‚Ä∫ generateShareLink ‚Ä∫ should generate share link with security options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "form-123", {"expirationHours": 24, "maxUses": 100, "password": "secret", "trackingEnabled": true, "
type": undefined}

    Number of calls: 0

      478 |
      479 |       // Assert
    > 480 |       expect(mockPublicationService.generateShareLink).toHaveBeenCalledWith('form-123', {
          |                                                        ^
      481 |         type: ShareLinkType.SECURE,
      482 |         password: 'secret',
      483 |         expirationHours: 24,

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:480:56)

  ‚óè FormSharingTool ‚Ä∫ generateShareLink ‚Ä∫ should handle share link generation errors

    expect(received).toEqual(expected) // deep equality

    - Expected  -  1
    + Received  + 11

      Object {
    -   "error": "Link generation failed",
    +   "error": "[
    +   {
    +     \"expected\": \"'standard' | 'embed' | 'qr_code' | 'social'\",
    +     \"received\": \"undefined\",
    +     \"code\": \"invalid_type\",
    +     \"path\": [
    +       \"type\"
    +     ],
    +     \"message\": \"Required\"
    +   }
    + ]",
        "message": "Failed to generate share link",
        "success": false,
      }

      498 |
      499 |       // Assert
    > 500 |       expect(result).toEqual({
          |                      ^
      501 |         success: false,
      502 |         error: 'Link generation failed',
      503 |         message: 'Failed to generate share link'

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:500:22)

  ‚óè FormSharingTool ‚Ä∫ edge cases and error handling ‚Ä∫ should handle empty form IDs array in bulk operation

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"error": "[
      {
        \"code\": \"too_small\",
        \"minimum\": 1,
        \"type\": \"array\",
        \"inclusive\": true,
        \"exact\": false,
        \"message\": \"Array must contain at least 1 element(s)\",
        \"path\": [
          \"formIds\"
        ]
      }
    ]", "message": "Failed to perform bulk operation", "success": false}

      828 |       // Act & Assert
      829 |       // The zod schema should throw a validation error for empty array
    > 830 |       await expect(formSharingTool.performBulkOperation(input)).rejects.toThrow();
          |             ^
      831 |     });
      832 |
      833 |     it('should handle invalid email in notification emails', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:830:13)

  ‚óè FormSharingTool ‚Ä∫ edge cases and error handling ‚Ä∫ should handle invalid email in notification emails

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"error": "[
      {
        \"validation\": \"email\",
        \"code\": \"invalid_string\",
        \"message\": \"Invalid email\",
        \"path\": [
          \"notificationEmails\",
          0
        ]
      }
    ]", "message": "Failed to publish form", "success": false}

      840 |       // Act & Assert
      841 |       // The zod schema should throw a validation error for invalid email
    > 842 |       await expect(formSharingTool.publishForm(input)).rejects.toThrow();
          |             ^
      843 |     });
      844 |
      845 |     it('should handle invalid datetime in publish date', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:842:13)

  ‚óè FormSharingTool ‚Ä∫ edge cases and error handling ‚Ä∫ should handle invalid datetime in publish date

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"error": "[
      {
        \"code\": \"invalid_string\",
        \"validation\": \"datetime\",
        \"message\": \"Invalid datetime\",
        \"path\": [
          \"publishDate\"
        ]
      }
    ]", "message": "Failed to publish form", "success": false}

      852 |       // Act & Assert
      853 |       // The zod schema should throw a validation error for invalid datetime
    > 854 |       await expect(formSharingTool.publishForm(input)).rejects.toThrow();
          |             ^
      855 |     });
      856 |   });
      857 | }); 

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:854:13)

 FAIL  src/validation/__tests__/schema-validator.test.ts
  SchemaValidator
    constructor
      ‚úì should create instance with default config (1 ms)
      ‚úì should create instance with custom config (1 ms)
    validateSchema
      ‚úì should validate a simple valid schema
      ‚úì should validate a complex valid object schema
      ‚úì should validate array schema (1 ms)
      ‚úì should return validation summary
    basic structure validation
      ‚úì should error when type is missing in strict mode (2 ms)
      ‚úì should not error when type is missing in non-strict mode (1 ms)
      ‚úì should error for invalid schema type
      ‚úì should accept all valid JSON Schema types (1 ms)
    object schema validation
      ‚úì should warn when object schema has no properties in strict mode (1 ms)
      ‚úì should not warn when object schema has no properties in non-strict mode
      ‚úì should error when required is not an array (1 ms)
      ‚úì should error when required item is not a string
      ‚úì should validate valid required array
    array schema validation
      ‚úì should warn when array schema has no items in strict mode (1 ms)
      ‚úì should not warn when array schema has no items in non-strict mode
      ‚úì should validate array schema with items (1 ms)
    JSON Schema draft validation
      ‚úì should warn for unsupported schema version
      ‚úì should not warn for supported schema version (1 ms)
      ‚úì should warn for deprecated keywords
      ‚úì should skip draft validation when disabled
    schema depth validation
      ‚úï should error when schema exceeds max depth
      ‚úì should allow custom max depth
      ‚úì should skip depth validation when maxSchemaDepth is undefined
    type-specific validation
      string schema validation
        ‚úì should error for negative minLength
        ‚úï should error for negative maxLength
        ‚úì should error when minLength > maxLength (1 ms)
        ‚úì should validate valid string constraints
      numeric schema validation
        ‚úì should error when minimum > maximum (1 ms)
        ‚úï should error when exclusiveMinimum >= exclusiveMaximum
        ‚úï should error for negative multipleOf
        ‚úì should validate valid numeric constraints
      object schema validation
        ‚úï should error for negative minProperties
        ‚úï should error for negative maxProperties (1 ms)
        ‚úì should error when minProperties > maxProperties
      array schema validation
        ‚úï should error for negative minItems
        ‚úï should error for negative maxItems (1 ms)
        ‚úì should error when minItems > maxItems
    edge cases
      ‚úì should handle empty schema object
      ‚úï should handle null schema
      ‚úì should handle schema with circular references
      ‚úì should handle very large schema (4 ms)

  ‚óè SchemaValidator ‚Ä∫ schema depth validation ‚Ä∫ should error when schema exceeds max depth

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      347 |       const result = validator.validateSchema(deepSchema);
      348 |
    > 349 |       expect(result.valid).toBe(false);
          |                            ^
      350 |       expect(result.errors.some(e => e.code === 'SCHEMA_DEPTH_EXCEEDED')).toBe(true);
      351 |     });
      352 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:349:28)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ string schema validation ‚Ä∫ should error for negative maxLength

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      412 |         const result = validator.validateSchema(schema);
      413 |
    > 414 |         expect(result.valid).toBe(false);
          |                              ^
      415 |         expect(result.errors.some(e => e.code === 'STRING_MAX_LENGTH_NEGATIVE')).toBe(true);
      416 |       });
      417 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:414:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ numeric schema validation ‚Ä∫ should error when exclusiveMinimum >=
 exclusiveMaximum

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      466 |         const result = validator.validateSchema(schema);
      467 |
    > 468 |         expect(result.valid).toBe(false);
          |                              ^
      469 |         expect(result.errors.some(e => e.code === 'NUMERIC_EXCLUSIVE_RANGE_CONFLICT')).toBe(true);
      470 |       });
      471 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:468:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ numeric schema validation ‚Ä∫ should error for negative multipleOf

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      479 |
      480 |         expect(result.valid).toBe(false);
    > 481 |         expect(result.errors.some(e => e.code === 'MULTIPLE_OF_NOT_POSITIVE')).toBe(true);
          |                                                                                ^
      482 |       });
      483 |
      484 |       it('should validate valid numeric constraints', () => {

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:481:80)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ object schema validation ‚Ä∫ should error for negative minPropertie
s

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      505 |         const result = validator.validateSchema(schema);
      506 |
    > 507 |         expect(result.valid).toBe(false);
          |                              ^
      508 |         expect(result.errors.some(e => e.code === 'OBJECT_MIN_PROPERTIES_NEGATIVE')).toBe(true);
      509 |       });
      510 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:507:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ object schema validation ‚Ä∫ should error for negative maxPropertie
s

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      517 |         const result = validator.validateSchema(schema);
      518 |
    > 519 |         expect(result.valid).toBe(false);
          |                              ^
      520 |         expect(result.errors.some(e => e.code === 'OBJECT_MAX_PROPERTIES_NEGATIVE')).toBe(true);
      521 |       });
      522 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:519:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ array schema validation ‚Ä∫ should error for negative minItems

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      544 |         const result = validator.validateSchema(schema);
      545 |
    > 546 |         expect(result.valid).toBe(false);
          |                              ^
      547 |         expect(result.errors.some(e => e.code === 'ARRAY_MIN_ITEMS_NEGATIVE')).toBe(true);
      548 |       });
      549 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:546:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ array schema validation ‚Ä∫ should error for negative maxItems

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      556 |         const result = validator.validateSchema(schema);
      557 |
    > 558 |         expect(result.valid).toBe(false);
          |                              ^
      559 |         expect(result.errors.some(e => e.code === 'ARRAY_MAX_ITEMS_NEGATIVE')).toBe(true);
      560 |       });
      561 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:558:30)

  ‚óè SchemaValidator ‚Ä∫ edge cases ‚Ä∫ should handle null schema

    TypeError: Cannot read properties of null (reading 'type')

      78 |   ): void {
      79 |     // Check if type is specified
    > 80 |     if (!schema.type && this.config.strict) {
         |                 ^
      81 |       errors.push({
      82 |         code: 'SCHEMA_TYPE_MISSING',
      83 |         message: 'Schema must specify a type property',

      at SchemaValidator.type [as validateBasicStructure] (src/validation/schema-validator.ts:80:17)
      at SchemaValidator.validateBasicStructure [as validateSchema] (src/validation/schema-validator.ts:43:10)
      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:589:32)

 FAIL  src/tools/__tests__/team-manager.test.ts
  TeamManager
    constructor
      ‚úì should create an instance with required dependencies (1 ms)
      ‚úì should create an instance with default config when none provided
    createTeam
      ‚úì should create a team successfully after validating workspace
      ‚úì should throw error if workspace validation fails (8 ms)
    getTeam
      ‚úì should get team details successfully (1 ms)
      ‚úì should propagate service errors
    updateTeam
      ‚úì should update team without parent change (1 ms)
      ‚úì should validate hierarchy when changing parent team (4 ms)
      ‚úï should handle setting parentTeamId to undefined (1 ms)
    deleteTeam
      ‚úì should delete team without options (1 ms)
      ‚úì should reassign members when reassignMembersTo option provided (1 ms)
      ‚úï should delete child teams when deleteChildTeams option is true (1 ms)
      ‚úì should move child teams to parent when deleteChildTeams is false
    getTeams
      ‚úì should get teams list successfully (1 ms)
      ‚úì should pass all options to service
    addTeamMember
      ‚úì should add team member with default role and permissions (1 ms)
      ‚úì should add team member with custom role and permissions (1 ms)
      ‚úì should throw error if team validation fails
    removeTeamMember
      ‚úì should remove team member successfully (1 ms)
    updateTeamMember
      ‚úì should update team member role and permissions (1 ms)
      ‚úì should update only role when permissions not provided (1 ms)
    bulkUpdateMemberships
      ‚úì should perform bulk membership updates (1 ms)
    moveUsersBetweenTeams
      ‚úì should move users between teams successfully (1 ms)
      ‚úì should use default member role when newRole not provided
    moveTeam
      ‚úï should move team to new parent (3 ms)
      ‚úï should make team a root team when newParentTeamId is undefined (1 ms)
    edge cases and error handling
      ‚úì should handle empty user array in moveUsersBetweenTeams
      ‚úì should handle team with no members in deleteTeam with reassignment (1 ms)
      ‚úï should handle team with no child teams in deleteTeam (1 ms)
    method chaining
      ‚úì should chain operations correctly (1 ms)

  ‚óè TeamManager ‚Ä∫ updateTeam ‚Ä∫ should handle setting parentTeamId to undefined

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "team-123", undefined

    Number of calls: 0

      209 |
      210 |       // Assert
    > 211 |       expect(validateSpy).toHaveBeenCalledWith('team-123', undefined);
          |                           ^
      212 |     });
      213 |   });
      214 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:211:27)

  ‚óè TeamManager ‚Ä∫ deleteTeam ‚Ä∫ should delete child teams when deleteChildTeams option is true

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

    - "child-team-1",
    + "team-123",
      {"deleteChildTeams": true},

    Number of calls: 1

      265 |
      266 |       // Assert
    > 267 |       expect(deleteSpy).toHaveBeenCalledWith('child-team-1', { deleteChildTeams: true });
          |                         ^
      268 |       expect(deleteSpy).toHaveBeenCalledWith('child-team-2', { deleteChildTeams: true });
      269 |     });
      270 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:267:25)

  ‚óè TeamManager ‚Ä∫ moveTeam ‚Ä∫ should move team to new parent

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "team-123", {"parentTeamId": "new-parent"}

    Number of calls: 0

      512 |       // Assert
      513 |       expect(validateSpy).toHaveBeenCalledWith('team-123', 'new-parent');
    > 514 |       expect(mockTeamService.updateTeam).toHaveBeenCalledWith('team-123', { parentTeamId: 'new-parent'
 });
          |                                          ^
      515 |       expect(result).toEqual(mockTeamResponse);
      516 |     });
      517 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:514:42)

  ‚óè TeamManager ‚Ä∫ moveTeam ‚Ä∫ should make team a root team when newParentTeamId is undefined

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "team-123", {"parentTeamId": undefined}

    Number of calls: 0

      526 |       // Assert
      527 |       expect(validateSpy).toHaveBeenCalledWith('team-123', undefined);
    > 528 |       expect(mockTeamService.updateTeam).toHaveBeenCalledWith('team-123', { parentTeamId: undefined })
;
          |                                          ^
      529 |     });
      530 |   });
      531 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:528:42)

  ‚óè TeamManager ‚Ä∫ edge cases and error handling ‚Ä∫ should handle team with no child teams in deleteTeam

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      579 |       const deleteSpy = jest.spyOn(teamManager, 'deleteTeam');
      580 |       // Should only be called once (for the main team, not recursively)
    > 581 |       expect(deleteSpy).toHaveBeenCalledTimes(1);
          |                         ^
      582 |     });
      583 |   });
      584 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:581:25)

 FAIL  src/__tests__/index.test.ts
  ‚óè Index.ts Entry Point ‚Ä∫ process error handlers ‚Ä∫ should handle unhandledRejection and exit

    Process exit called with code: 1

      64 |     // Spy on process.exit
      65 |     processExitSpy = jest.spyOn(process, 'exit').mockImplementation((code?: string | number | null | un
defined) => {
    > 66 |       throw new Error(`Process exit called with code: ${code}`);
         |             ^
      67 |     });
      68 |   });
      69 |

      at process.<anonymous> (src/__tests__/index.test.ts:66:13)
      at process.exit (src/index.ts:40:11)
      at Object.<anonymous> (src/__tests__/index.test.ts:202:17)

  ‚óè Index.ts Entry Point ‚Ä∫ process error handlers ‚Ä∫ should handle uncaughtException and exit

    Process exit called with code: 1

      64 |     // Spy on process.exit
      65 |     processExitSpy = jest.spyOn(process, 'exit').mockImplementation((code?: string | number | null | un
defined) => {
    > 66 |       throw new Error(`Process exit called with code: ${code}`);
         |             ^
      67 |     });
      68 |   });
      69 |

      at process.<anonymous> (src/__tests__/index.test.ts:66:13)
      at process.exit (src/index.ts:46:11)
      at Object.<anonymous> (src/__tests__/index.test.ts:216:17)


  ‚óè Test suite failed to run

    Test unhandled rejection

      196 |         require('../index');
      197 |         
    > 198 |         const testError = new Error('Test unhandled rejection');
          |                           ^
      199 |         const testPromise = Promise.reject(testError);
      200 |
      201 |         // Simulate the event

      at Object.<anonymous> (src/__tests__/index.test.ts:198:27)

 FAIL  src/__tests__/worker.test.ts
  Cloudflare Worker Components
    Environment Interface
      ‚úì should define required environment variables (1 ms)
      ‚úì should handle missing optional environment variables
    MCP Protocol Structures
      ‚úì should validate MCP request structure (1 ms)
      ‚úì should validate MCP response structure
      ‚úì should validate MCP error response structure (1 ms)
    Tool Schema Validation
      ‚úì should validate create_form tool schema structure
      ‚úì should validate form status enum values (1 ms)
      ‚úì should validate field type mappings (1 ms)
    Session Management
      ‚úì should validate SSE session structure (1 ms)
      ‚úì should handle session cleanup logic
    API Key Validation
      ‚úì should validate API key format requirements (1 ms)
      ‚úì should handle API key extraction from different sources (2 ms)
    Error Response Generation
      ‚úì should generate JSON-RPC error responses
      ‚úì should generate appropriate HTTP status codes
    CORS Headers Management
      ‚úì should define proper CORS headers (1 ms)
      ‚úì should handle preflight request detection
    Request Method Routing
      ‚úì should identify different request types (1 ms)
      ‚úì should validate method-path combinations
    Main Worker Fetch Handler
      ‚úï should handle preflight (OPTIONS) requests (6 ms)
      ‚úï should reject unauthorized MCP requests (1 ms)
      ‚úï should process a valid MCP request with API key in header
      ‚úï should process a valid MCP request with API key in query param (for authless transport) (1 ms)
      ‚úï should handle SSE connection requests (1 ms)
      ‚úï should reject SSE connection without API key
      ‚úì should return 404 for unknown paths

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should handle preflight (OPTIONS) requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 204
    Received: 200

      468 |
      469 |       const response = await worker.default.fetch(request, mockEnv);
    > 470 |       expect(response.status).toBe(204);
          |                               ^
      471 |       expect(response.headers.get('Access-Control-Allow-Origin')).toBe('*');
      472 |       expect(response.headers.get('Access-Control-Allow-Methods')).toContain('POST');
      473 |     });

      at Object.<anonymous> (src/__tests__/worker.test.ts:470:31)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should reject unauthorized MCP requests

    expect(received).toBe(expected) // Object.is equality

    Expected: "Unauthorized"
    Received: undefined

      483 |       expect(response.status).toBe(401);
      484 |       const json = await response.json();
    > 485 |       expect(json.error.message).toBe('Unauthorized');
          |                                  ^
      486 |     });
      487 |
      488 |     it('should process a valid MCP request with API key in header', async () => {

      at Object.<anonymous> (src/__tests__/worker.test.ts:485:34)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should process a valid MCP request with API key in 
header

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      498 |   
      499 |         const response = await worker.default.fetch(request, mockEnv);
    > 500 |         expect(response.status).toBe(200);
          |                                 ^
      501 |         const json = await response.json();
      502 |         expect(json.id).toBe(1);
      503 |         expect(json.result.capabilities.protocolVersion).toBe('1.0.0');

      at Object.<anonymous> (src/__tests__/worker.test.ts:500:33)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should process a valid MCP request with API key in 
query param (for authless transport)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      513 |   
      514 |         const response = await worker.default.fetch(request, mockEnv);
    > 515 |         expect(response.status).toBe(200);
          |                                 ^
      516 |         const json = await response.json();
      517 |         expect(json.id).toBe(2);
      518 |         expect(json.result.capabilities).toBeDefined();

      at Object.<anonymous> (src/__tests__/worker.test.ts:515:33)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should handle SSE connection requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      526 |   
      527 |         const response = await worker.default.fetch(request, mockEnv);
    > 528 |         expect(response.status).toBe(200);
          |                                 ^
      529 |         expect(response.headers.get('Content-Type')).toBe('text/event-stream; charset=utf-8');
      530 |     });
      531 |

      at Object.<anonymous> (src/__tests__/worker.test.ts:528:33)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should reject SSE connection without API key

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 404

      537 |   
      538 |         const response = await worker.default.fetch(request, mockEnv);
    > 539 |         expect(response.status).toBe(401);
          |                                 ^
      540 |     });
      541 |
      542 |     it('should return 404 for unknown paths', async () => {

      at Object.<anonymous> (src/__tests__/worker.test.ts:539:33)

 FAIL  src/middleware/__tests__/api-key-auth.test.ts
  API Key Authentication Middleware
    apiKeyAuth
      ‚úì should call next() if API key is valid (1 ms)
      ‚úì should return 401 if API key is missing (3 ms)
      ‚úì should call next() if API key is missing but auth is optional
      ‚úì should return 401 if API key is invalid (1 ms)
      ‚úì should return 401 if API key is expired
      ‚úì should return 403 if API key is revoked (1 ms)
      ‚úï should return 429 if usage limit is exceeded
      ‚úì should return 403 if IP is not whitelisted (1 ms)
      ‚úì should return 403 if scopes are insufficient (1 ms)
      ‚úì should extract API key from Authorization Bearer header
      ‚úì should extract API key from query parameter in non-production environment (1 ms)
    Scope Requirement Helpers
      ‚úï requireScopes should succeed with adequate scopes (1 ms)
      ‚úï requireReadAccess should succeed with READ scope
      ‚úì requireWriteAccess should fail without WRITE scopes (1 ms)
      ‚úï requireAdminAccess should succeed with ADMIN scope
    optionalApiKeyAuth
      ‚úì should call next() when no key is provided
      ‚úì should authenticate and attach apiKey when a valid key is provided (2 ms)
    Utility Functions
      ‚úì isAuthenticated should return true if apiKey is on request (1 ms)
      ‚úì isAuthenticated should return false if apiKey is not on request
      ‚úì getApiKeyInfo should return apiKey info
      ‚úì getApiKeyInfo should return undefined if no apiKey is on request (1 ms)

  ‚óè API Key Authentication Middleware ‚Ä∫ apiKeyAuth ‚Ä∫ should return 429 if usage limit is exceeded

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 429
    Received: 401

    Number of calls: 1

      155 |       
      156 |         expect(nextFunction).not.toHaveBeenCalled();
    > 157 |         expect(statusSpy).toHaveBeenCalledWith(429);
          |                           ^
      158 |         expect(jsonSpy).toHaveBeenCalledWith(expect.objectContaining({
      159 |           code: 'USAGE_LIMIT_EXCEEDED',
      160 |           message: 'API key usage limit exceeded',

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:157:27)

  ‚óè API Key Authentication Middleware ‚Ä∫ Scope Requirement Helpers ‚Ä∫ requireScopes should succeed with adequate sco
pes

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      276 |     it('requireScopes should succeed with adequate scopes', async () => {
      277 |       await requireScopes([ApiKeyScope.FORMS_READ])(mockRequest as Request, mockResponse as Response, 
nextFunction);
    > 278 |       expect(nextFunction).toHaveBeenCalled();
          |                            ^
      279 |     });
      280 |   
      281 |     it('requireReadAccess should succeed with READ scope', async () => {

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:278:28)

  ‚óè API Key Authentication Middleware ‚Ä∫ Scope Requirement Helpers ‚Ä∫ requireReadAccess should succeed with READ sco
pe

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      295 |         mockedApiKeyService.validateApiKey.mockResolvedValue(readValidationResult);
      296 |         await requireReadAccess()(mockRequest as Request, mockResponse as Response, nextFunction);
    > 297 |         expect(nextFunction).toHaveBeenCalled();
          |                              ^
      298 |     });
      299 |
      300 |     it('requireWriteAccess should fail without WRITE scopes', async () => {

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:297:30)

  ‚óè API Key Authentication Middleware ‚Ä∫ Scope Requirement Helpers ‚Ä∫ requireAdminAccess should succeed with ADMIN s
cope

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      333 |         mockedApiKeyService.validateApiKey.mockResolvedValue(adminValidationResult);
      334 |         await requireAdminAccess()(mockRequest as Request, mockResponse as Response, nextFunction);
    > 335 |         expect(nextFunction).toHaveBeenCalled();
          |                              ^
      336 |     });
      337 |   });
      338 |

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:335:30)

 FAIL  src/__tests__/api/TallyApiClient.test.ts
  ‚óè TallyApiClient ‚Ä∫ Request Handling ‚Ä∫ should handle a 404 Not Found error

    expect(received).rejects.toThrow(expected)

    Expected substring: "Not Found"

    Received function did not throw

      88 |       client = new TallyApiClient({ accessToken: env.TALLY_API_KEY });
      89 |       
    > 90 |       await expect(client.get('/non-existent-endpoint')).rejects.toThrow('Not Found');
         |                                                                  ^
      91 |     });
      92 |
      93 |     it('should handle a 401 Unauthorized error', async () => {

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:90:66)

  ‚óè TallyApiClient ‚Ä∫ Request Handling ‚Ä∫ should handle a 401 Unauthorized error

    expect(received).rejects.toThrow(expected)

    Expected substring: "No valid authentication found. Please authenticate first."
    Received message:   "this.axiosInstance.request is not a function"

          586 |
          587 |     // The interceptors will handle authentication and error handling
        > 588 |     const response: AxiosResponse<T> = await this.axiosInstance.request(requestConfig);
              |                                                                 ^
          589 |
          590 |     return {
          591 |       data: response.data,

          at TallyApiClient.request (src/services/TallyApiClient.ts:588:65)
          at TallyApiClient.request [as get] (src/services/TallyApiClient.ts:348:17)
          at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:96:27)

      94 |       mockedCreate.mockReturnValue({ defaults: { headers: { common: {} } }, interceptors: { request: { 
use: jest.fn() }, response: { use: jest.fn() } } });
      95 |       client = new TallyApiClient(); // No access token
    > 96 |       await expect(client.get('/me')).rejects.toThrow('No valid authentication found. Please authentica
te first.');
         |                                               ^
      97 |     });
      98 |   });
      99 | }); 

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:96:47)


  ‚óè Test suite failed to run

    thrown: Object {
      "isAxiosError": true,
      "response": Object {
        "data": Object {
          "message": "Not Found",
        },
        "status": 404,
      },
    }

      at _getError (node_modules/jest-circus/build/utils.js:432:18)
          at Array.map (<anonymous>)

  ‚óè Test suite failed to run

    NotFoundError: Not Found

      289 |     
      290 |     case 404:
    > 291 |       return new NotFoundError(message, statusCode, statusText, headers, originalError);
          |              ^
      292 |     
      293 |     case 429:
      294 |       return new RateLimitError(message, statusCode, statusText, headers, originalError);

      at createErrorFromResponse (src/models/errors.ts:291:14)
      at TallyApiClient.handleResponseError (src/services/TallyApiClient.ts:876:54)
      at handleResponseError (src/services/TallyApiClient.ts:999:21)
      at Object.mockInterceptor [as use] (src/__tests__/api/TallyApiClient.test.ts:85:57)
      at TallyApiClient.use [as setupInterceptors] (src/services/TallyApiClient.ts:987:46)
      at new setupInterceptors (src/services/TallyApiClient.ts:220:10)
      at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:88:16)

 FAIL  src/validation/__tests__/validation-utils.test.ts
  ValidationUtils
    createError
      ‚úì should create a validation error with required fields
      ‚úì should create a validation error with optional fields (1 ms)
    formatPath
      ‚úï should format simple path
      ‚úï should format array index path
      ‚úï should handle empty path
      ‚úï should handle single element path
    isValidJsonSchemaType
      ‚úï should return true for valid types
      ‚úï should return false for invalid types (1 ms)
      ‚úï should handle null and undefined
    mergeValidationResults
      ‚úï should merge two validation results
      ‚úï should handle empty results
    validateRequired
      ‚úï should validate required fields are present
      ‚úï should return errors for missing required fields (1 ms)
      ‚úï should handle empty required array
      ‚úï should handle null/undefined data
    sanitizeErrorMessage
      ‚úï should sanitize error messages (1 ms)
      ‚úï should preserve safe content
      ‚úï should handle empty and null messages
    getErrorSeverityLevel
      ‚úï should return correct numeric levels for severities
      ‚úï should handle invalid severity
    sortErrorsBySeverity
      ‚úï should sort errors by severity (highest first)
      ‚úï should handle empty array (1 ms)

  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should format simple path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      51 |   describe('formatPath', () => {
      52 |     it('should format simple path', () => {
    > 53 |       const formatted = ValidationUtils.formatPath(['root', 'child']);
         |                                         ^
      54 |       expect(formatted).toBe('root.child');
      55 |     });
      56 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:53:41)

  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should format array index path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      56 |
      57 |     it('should format array index path', () => {
    > 58 |       const formatted = ValidationUtils.formatPath(['root', '0', 'child']);
         |                                         ^
      59 |       expect(formatted).toBe('root[0].child');
      60 |     });
      61 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:58:41)

  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should handle empty path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      61 |
      62 |     it('should handle empty path', () => {
    > 63 |       const formatted = ValidationUtils.formatPath([]);
         |                                         ^
      64 |       expect(formatted).toBe('');
      65 |     });
      66 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:63:41)

  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should handle single element path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      66 |
      67 |     it('should handle single element path', () => {
    > 68 |       const formatted = ValidationUtils.formatPath(['root']);
         |                                         ^
      69 |       expect(formatted).toBe('root');
      70 |     });
      71 |   });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:68:41)

  ‚óè ValidationUtils ‚Ä∫ isValidJsonSchemaType ‚Ä∫ should return true for valid types

    TypeError: validation_utils_1.ValidationUtils.isValidJsonSchemaType is not a function

      76 |       
      77 |       validTypes.forEach(type => {
    > 78 |         expect(ValidationUtils.isValidJsonSchemaType(type)).toBe(true);
         |                                ^
      79 |       });
      80 |     });
      81 |

      at src/validation/__tests__/validation-utils.test.ts:78:32
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:77:18)

  ‚óè ValidationUtils ‚Ä∫ isValidJsonSchemaType ‚Ä∫ should return false for invalid types

    TypeError: validation_utils_1.ValidationUtils.isValidJsonSchemaType is not a function

      84 |       
      85 |       invalidTypes.forEach(type => {
    > 86 |         expect(ValidationUtils.isValidJsonSchemaType(type)).toBe(false);
         |                                ^
      87 |       });
      88 |     });
      89 |

      at src/validation/__tests__/validation-utils.test.ts:86:32
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:85:20)

  ‚óè ValidationUtils ‚Ä∫ isValidJsonSchemaType ‚Ä∫ should handle null and undefined

    TypeError: validation_utils_1.ValidationUtils.isValidJsonSchemaType is not a function

      89 |
      90 |     it('should handle null and undefined', () => {
    > 91 |       expect(ValidationUtils.isValidJsonSchemaType(null as any)).toBe(false);
         |                              ^
      92 |       expect(ValidationUtils.isValidJsonSchemaType(undefined as any)).toBe(false);
      93 |     });
      94 |   });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:91:30)

  ‚óè ValidationUtils ‚Ä∫ mergeValidationResults ‚Ä∫ should merge two validation results

    TypeError: validation_utils_1.ValidationUtils.mergeValidationResults is not a function

      112 |       };
      113 |
    > 114 |       const merged = ValidationUtils.mergeValidationResults(result1, result2);
          |                                      ^
      115 |
      116 |       expect(merged.valid).toBe(false); // Should be false if any result is invalid
      117 |       expect(merged.errors).toHaveLength(1);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:114:38)

  ‚óè ValidationUtils ‚Ä∫ mergeValidationResults ‚Ä∫ should handle empty results

    TypeError: validation_utils_1.ValidationUtils.mergeValidationResults is not a function

      134 |       };
      135 |
    > 136 |       const merged = ValidationUtils.mergeValidationResults(emptyResult, emptyResult);
          |                                      ^
      137 |
      138 |       expect(merged.valid).toBe(true);
      139 |       expect(merged.errors).toHaveLength(0);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:136:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should validate required fields are present

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      153 |       const required = ['name', 'age'];
      154 |
    > 155 |       const errors = ValidationUtils.validateRequired(data, required);
          |                                      ^
      156 |
      157 |       expect(errors).toHaveLength(0);
      158 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:155:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should return errors for missing required fields

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      162 |       const required = ['name', 'age', 'email'];
      163 |
    > 164 |       const errors = ValidationUtils.validateRequired(data, required);
          |                                      ^
      165 |
      166 |       expect(errors).toHaveLength(2);
      167 |       expect(errors[0].code).toBe('REQUIRED_FIELD_MISSING');

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:164:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should handle empty required array

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      175 |       const required: string[] = [];
      176 |
    > 177 |       const errors = ValidationUtils.validateRequired(data, required);
          |                                      ^
      178 |
      179 |       expect(errors).toHaveLength(0);
      180 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:177:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should handle null/undefined data

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      183 |       const required = ['name'];
      184 |
    > 185 |       const errorsNull = ValidationUtils.validateRequired(null, required);
          |                                          ^
      186 |       const errorsUndefined = ValidationUtils.validateRequired(undefined, required);
      187 |
      188 |       expect(errorsNull).toHaveLength(1);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:185:42)

  ‚óè ValidationUtils ‚Ä∫ sanitizeErrorMessage ‚Ä∫ should sanitize error messages

    TypeError: validation_utils_1.ValidationUtils.sanitizeErrorMessage is not a function

      194 |     it('should sanitize error messages', () => {
      195 |       const message = 'Error with <script>alert("xss")</script> content';
    > 196 |       const sanitized = ValidationUtils.sanitizeErrorMessage(message);
          |                                         ^
      197 |
      198 |       expect(sanitized).not.toContain('<script>');
      199 |       expect(sanitized).not.toContain('alert');

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:196:41)

  ‚óè ValidationUtils ‚Ä∫ sanitizeErrorMessage ‚Ä∫ should preserve safe content

    TypeError: validation_utils_1.ValidationUtils.sanitizeErrorMessage is not a function

      202 |     it('should preserve safe content', () => {
      203 |       const message = 'Simple error message with numbers 123 and symbols !@#';
    > 204 |       const sanitized = ValidationUtils.sanitizeErrorMessage(message);
          |                                         ^
      205 |
      206 |       expect(sanitized).toBe(message);
      207 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:204:41)

  ‚óè ValidationUtils ‚Ä∫ sanitizeErrorMessage ‚Ä∫ should handle empty and null messages

    TypeError: validation_utils_1.ValidationUtils.sanitizeErrorMessage is not a function

      208 |
      209 |     it('should handle empty and null messages', () => {
    > 210 |       expect(ValidationUtils.sanitizeErrorMessage('')).toBe('');
          |                              ^
      211 |       expect(ValidationUtils.sanitizeErrorMessage(null as any)).toBe('');
      212 |       expect(ValidationUtils.sanitizeErrorMessage(undefined as any)).toBe('');
      213 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:210:30)

  ‚óè ValidationUtils ‚Ä∫ getErrorSeverityLevel ‚Ä∫ should return correct numeric levels for severities

    TypeError: validation_utils_1.ValidationUtils.getErrorSeverityLevel is not a function

      216 |   describe('getErrorSeverityLevel', () => {
      217 |     it('should return correct numeric levels for severities', () => {
    > 218 |       expect(ValidationUtils.getErrorSeverityLevel(ValidationSeverity.ERROR)).toBe(3);
          |                              ^
      219 |       expect(ValidationUtils.getErrorSeverityLevel(ValidationSeverity.WARNING)).toBe(2);
      220 |       expect(ValidationUtils.getErrorSeverityLevel(ValidationSeverity.INFO)).toBe(1);
      221 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:218:30)

  ‚óè ValidationUtils ‚Ä∫ getErrorSeverityLevel ‚Ä∫ should handle invalid severity

    TypeError: validation_utils_1.ValidationUtils.getErrorSeverityLevel is not a function

      222 |
      223 |     it('should handle invalid severity', () => {
    > 224 |       expect(ValidationUtils.getErrorSeverityLevel('invalid' as any)).toBe(0);
          |                              ^
      225 |     });
      226 |   });
      227 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:224:30)

  ‚óè ValidationUtils ‚Ä∫ sortErrorsBySeverity ‚Ä∫ should sort errors by severity (highest first)

    TypeError: validation_utils_1.ValidationUtils.sortErrorsBySeverity is not a function

      235 |       ];
      236 |
    > 237 |       const sorted = ValidationUtils.sortErrorsBySeverity(errors);
          |                                      ^
      238 |
      239 |       expect(sorted[0].severity).toBe(ValidationSeverity.ERROR);
      240 |       expect(sorted[1].severity).toBe(ValidationSeverity.ERROR);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:237:38)

  ‚óè ValidationUtils ‚Ä∫ sortErrorsBySeverity ‚Ä∫ should handle empty array

    TypeError: validation_utils_1.ValidationUtils.sortErrorsBySeverity is not a function

      244 |
      245 |     it('should handle empty array', () => {
    > 246 |       const sorted = ValidationUtils.sortErrorsBySeverity([]);
          |                                      ^
      247 |       expect(sorted).toHaveLength(0);
      248 |     });
      249 |   });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:246:38)

 FAIL  src/validation/__tests__/validation-utils-simple.test.ts
  ValidationUtils
    createError
      ‚úì should create a validation error with required fields
      ‚úì should create a validation error with optional fields (1 ms)
      ‚úì should use default severity when not provided (2 ms)
    mergeResults
      ‚úì should merge multiple validation results
      ‚úì should handle empty results (1 ms)
      ‚úì should handle single result
    formatError
      ‚úì should format basic error (1 ms)
      ‚úì should format error with path
      ‚úì should format error with expected/actual values
      ‚úì should format error with spec reference (1 ms)
    calculateComplexity
      ‚úì should calculate complexity for simple schema
      ‚úï should calculate complexity for object schema
      ‚úì should calculate complexity for nested schema
      ‚úì should handle null/undefined schema (1 ms)
      ‚úì should handle empty schema

  ‚óè ValidationUtils ‚Ä∫ calculateComplexity ‚Ä∫ should calculate complexity for object schema

    expect(received).toBe(expected) // Object.is equality

    Expected: 4
    Received: 5.5

      174 |
      175 |       expect(complexity).toBeGreaterThan(1);
    > 176 |       expect(complexity).toBe(4); // 1 base + 3 properties
          |                          ^
      177 |     });
      178 |
      179 |     it('should calculate complexity for nested schema', () => {

      at Object.<anonymous> (src/validation/__tests__/validation-utils-simple.test.ts:176:26)

 FAIL  src/utils/__tests__/config.test.ts
  Application Configuration
    ‚úì should load configuration from environment variables (5 ms)
    ‚úï should use default values for optional variables (1 ms)
    ‚úï should throw an error if a required environment variable is missing (1 ms)
    ‚úì should throw an error for non-numeric number variables (3 ms)
    validateConfig
      ‚úì should log success if all required config is present (1 ms)
      ‚úï should log an error and exit if required config is missing (2 ms)

  ‚óè Application Configuration ‚Ä∫ should use default values for optional variables

    expect(received).toBe(expected) // Object.is equality

    Expected: "development"
    Received: "test"

      42 |     expect(reloadedConfig.tally.apiBaseUrl).toBe('https://api.tally.so/v1');
      43 |     expect(reloadedConfig.server.port).toBe(3000);
    > 44 |     expect(reloadedConfig.development.nodeEnv).toBe('development');
         |                                                ^
      45 |     expect(reloadedConfig.development.debug).toBe(false);
      46 |   });
      47 |

      at Object.<anonymous> (src/utils/__tests__/config.test.ts:44:48)

  ‚óè Application Configuration ‚Ä∫ should throw an error if a required environment variable is missing

    expect(received).toThrow(expected)

    Expected substring: "Required environment variable TALLY_API_KEY is not set"

    Received function did not throw

      51 |     delete process.env.TALLY_API_KEY;
      52 |     
    > 53 |     expect(() => require('../config')).toThrow('Required environment variable TALLY_API_KEY is not set'
);
         |                                        ^
      54 |   });
      55 |
      56 |   it('should throw an error for non-numeric number variables', () => {

      at Object.<anonymous> (src/utils/__tests__/config.test.ts:53:40)

  ‚óè Application Configuration ‚Ä∫ validateConfig ‚Ä∫ should log an error and exit if required config is missing

    Required environment variable JWT_SECRET is not set

      51 |   const value = process.env[name];
      52 |   if (!value) {
    > 53 |     throw new Error(`Required environment variable ${name} is not set`);
         |           ^
      54 |   }
      55 |   return value;
      56 | }

      at getRequiredEnvVar (src/utils/config.ts:53:11)
      at Object.getRequiredEnvVar (src/utils/config.ts:108:16)
      at Object.<anonymous> (src/utils/__tests__/config.test.ts:101:54)

 FAIL  src/__tests__/utils/capability-negotiation.test.ts
  capability-negotiation
    negotiateCapabilities
      ‚úì should return server defaults when no client capabilities provided
      ‚úì should throw StructuredError on protocol version mismatch (7 ms)
      ‚úì should negotiate tools capabilities correctly
      ‚úì should negotiate resources capabilities correctly (1 ms)
      ‚úì should negotiate prompts capabilities correctly
      ‚úì should negotiate logging capabilities correctly
      ‚úï should handle partial client capabilities (3 ms)
      ‚úì should handle all capabilities disabled by client (1 ms)

  ‚óè capability-negotiation ‚Ä∫ negotiateCapabilities ‚Ä∫ should handle partial client capabilities

    expect(received).toEqual(expected) // deep equality

    Expected: {"get": true, "list": true, "listChanged": true, "subscribe": true}
    Received: undefined

      142 |
      143 |       // Prompts and logging should inherit server defaults
    > 144 |       expect(result.prompts).toEqual(DEFAULT_SERVER_CAPABILITIES.prompts);
          |                              ^
      145 |       expect(result.logging).toEqual(DEFAULT_SERVER_CAPABILITIES.logging);
      146 |     });
      147 |

      at Object.<anonymous> (src/__tests__/utils/capability-negotiation.test.ts:144:30)

 FAIL  src/utils/__tests__/capability-negotiation.test.ts
  Capability Negotiation
    negotiateCapabilities
      ‚úì should return server defaults when no client capabilities are provided
      ‚úì should throw an error for incompatible protocol versions (8 ms)
      ‚úï should successfully negotiate capabilities when versions match
      ‚úì should use server default when a client capability is not specified
    validateClientCapabilities
      ‚úì should return true for valid client capabilities
      ‚úì should return false for non-object capabilities (1 ms)
      ‚úì should return false for an unknown capability category
      ‚úì should return false if a capability category is not an object
      ‚úì should return false for an invalid logging level
      ‚úì should return true for valid capabilities with missing categories (1 ms)

  ‚óè Capability Negotiation ‚Ä∫ negotiateCapabilities ‚Ä∫ should successfully negotiate capabilities when versions matc
h

    expect(received).toEqual(expected) // deep equality

    Expected: {"delete": true, "get": true, "listChanged": true, "put": true, "subscribe": true}
    Received: undefined

      47 |
      48 |       // Check resources (client didn't specify, should be server default)
    > 49 |       expect(negotiated.resources).toEqual(DEFAULT_SERVER_CAPABILITIES.resources);
         |                                    ^
      50 |     });
      51 |
      52 |     it('should use server default when a client capability is not specified', () => {

      at Object.<anonymous> (src/utils/__tests__/capability-negotiation.test.ts:49:36)

 PASS  src/__tests__/middleware-sse.test.ts
  Express Middleware and SSE Transport
    Middleware Stack
      ‚úì should handle CORS headers correctly (105 ms)
      ‚úì should handle JSON body parsing (103 ms)
      ‚úì should enforce connection limits (104 ms)
      ‚úì should handle malformed JSON gracefully (106 ms)
    SSE Transport
      ‚úì should establish SSE connection with proper headers (112 ms)
      ‚úì should track connection count correctly (313 ms)
    MCP Message Handling
      ‚úì should process valid MCP messages (105 ms)
      ‚úì should reject invalid message format (103 ms)
      ‚úì should handle missing message properties (104 ms)
    Error Handling
      ‚úì should handle request timeout gracefully (107 ms)
      ‚úì should handle server errors gracefully (102 ms)
    Security Features
      ‚úì should have security headers set (105 ms)
      ‚úì should handle large payloads within limits (107 ms)

 PASS  src/middleware/__tests__/rateLimiter.test.ts
  Rate Limiter Middleware
    Basic Rate Limiting
      ‚úì should allow requests within the limit (24 ms)
      ‚úì should block requests that exceed the limit (14 ms)
      ‚úì should skip rate limiting for health checks (17 ms)
    Pre-configured Rate Limiters
      ‚úì should apply strict rate limiting (5 ms)
      ‚úì should apply standard rate limiting (4 ms)
      ‚úì should apply lenient rate limiting (5 ms)
    Tally API Rate Limiter
      ‚úì should allow requests when tokens are available (6 ms)
      ‚úì should block requests when no tokens are available (4 ms)
      ‚úì should refill tokens over time (5 ms)
    Composite Rate Limiter
      ‚úì should apply both rate limiters (6 ms)
      ‚úì should be blocked by Tally API limiter when tokens exhausted (5 ms)
    Rate Limit Error Handler
      ‚úì should handle rate limit errors (3 ms)
      ‚úì should pass through non-rate-limit errors (1 ms)
    Rate Limit Status Utility
      ‚úì should return current rate limit status (1 ms)
    Token Bucket Algorithm
      ‚úì should refill tokens at the correct rate
      ‚úì should not exceed maximum tokens (1 ms)
      ‚úì should calculate correct time until next token
  Rate Limit Configurations
    ‚úì should have correct strict configuration (2 ms)
    ‚úì should have correct standard configuration
    ‚úì should have correct lenient configuration

 PASS  src/utils/__tests__/input-sanitizer.test.ts
  Input Sanitization
    sanitizeString
      ‚úì should strip script tags by default (1 ms)
      ‚úì should remove javascript: protocols (2 ms)
      ‚úì should strip event handlers (1 ms)
      ‚úì should allow basic formatting when configured
      ‚úì should allow links when configured
      ‚úì should handle non-string input gracefully (1 ms)
      ‚úì should remove potentially dangerous iframe tags (1 ms)
      ‚úì should sanitize data attributes (1 ms)
    sanitizeObject
      ‚úì should sanitize all string values in an object (1 ms)
      ‚úì should handle nested objects (2 ms)
      ‚úì should handle arrays within objects (1 ms)
      ‚úì should handle null and undefined values
    sanitizeArray
      ‚úì should sanitize string elements in arrays (5 ms)
      ‚úì should handle non-array input
    InputValidator
      isValidId
        ‚úì should accept valid IDs
        ‚úì should reject invalid IDs
      isValidEmail
        ‚úì should accept valid emails (1 ms)
        ‚úì should reject invalid emails (1 ms)
      isValidUrl
        ‚úì should accept valid URLs
        ‚úì should reject invalid URLs
      containsOnlySafeChars
        ‚úì should accept safe text
        ‚úì should reject potentially dangerous characters
      containsSqlInjectionPatterns
        ‚úì should detect SQL injection attempts (1 ms)
        ‚úì should not flag normal text
      containsXssPatterns
        ‚úì should detect XSS attempts (1 ms)
        ‚úì should not flag normal HTML
    Edge Cases and Security Tests
      ‚úì should handle unicode and special characters
      ‚úì should prevent script injection through encoded characters (1 ms)
      ‚úì should handle very long strings (4 ms)
      ‚úì should handle empty and whitespace-only strings (1 ms)
      ‚úì should prevent style-based attacks (26 ms)
    SanitizationPresets
      ‚úì should have different levels of strictness (3 ms)

 PASS  src/__tests__/workflow.integration.test.ts
  User Workflow Integration Tests
    Form Creation Workflow
      ‚úì should create a form from a natural language prompt via MCP (18 ms)
    Form Modification Workflow
      ‚úì should modify a form from a natural language prompt via MCP (6 ms)
    Form Sharing Workflow
      ‚úì should get form sharing details via MCP (7 ms)
    Team Management Workflow
      ‚úì should invite a team member via MCP (5 ms)
    Submission Management Workflow
      ‚úì should get form submissions via MCP (5 ms)
    Template Workflow
      ‚úì should create a form from a template via MCP (6 ms)

 PASS  src/__tests__/server-lifecycle.test.ts
  MCPServer Lifecycle Management
    Server Initialization
      ‚úì should initialize server successfully (3 ms)
      ‚úì should not allow initialization when not stopped (2 ms)
      ‚úì should serve basic endpoint after initialization (6 ms)
      ‚úì should handle initialization errors gracefully (93 ms)
    Server Shutdown
      ‚úì should shutdown server gracefully (2 ms)
      ‚úì should handle shutdown when already stopped (1 ms)
      ‚úì should close server endpoint after shutdown (3 ms)
    Server State Management
      ‚úì should track state transitions correctly (2 ms)
    Configuration Handling
      ‚úì should use custom configuration during initialization (6 ms)

 PASS  src/middleware/__tests__/validation.test.ts
  Validation Middleware
    createValidationMiddleware
      ‚úì should validate request body successfully (4 ms)
      ‚úì should reject invalid request body (1 ms)
      ‚úì should validate query parameters
      ‚úì should validate URL parameters (1 ms)
      ‚úì should validate headers
      ‚úì should perform security checks when enabled
      ‚úì should detect SQL injection patterns (1 ms)
      ‚úì should handle partial validation
      ‚úì should strip unknown fields when configured (1 ms)
      ‚úì should handle validation errors gracefully
    CommonSchemas
      pagination
        ‚úì should validate valid pagination parameters (1 ms)
        ‚úì should apply default values
        ‚úì should reject invalid pagination
      formId
        ‚úì should validate valid form IDs (1 ms)
        ‚úì should reject invalid form IDs
        ‚úì should reject empty form IDs
      dateRange
        ‚úì should validate valid date ranges
        ‚úì should reject invalid date ranges
      search
        ‚úì should validate safe search queries (1 ms)
        ‚úì should reject SQL injection attempts
        ‚úì should reject XSS attempts
      fileUpload
        ‚úì should validate valid file uploads (3 ms)
        ‚úì should reject files that are too large
        ‚úì should reject invalid MIME types
    ValidationMiddleware presets
      ‚úì should validate pagination middleware (1 ms)
      ‚úì should validate form params middleware
      ‚úì should validate search middleware
      ‚úì should reject malicious search queries
    Helper functions
      validateWithSchema
        ‚úì should validate data successfully
        ‚úì should return errors for invalid data
      createTypedValidator
        ‚úì should create a type guard function
      formatValidationError
        ‚úì should format validation errors correctly (1 ms)
    Security Features
      ‚úì should detect and block length-based attacks
      ‚úì should handle nested object security checks (1 ms)

 PASS  src/__tests__/json-rpc-message-validation.test.ts
  JSON-RPC 2.0 Message Validation
    JSON-RPC 2.0 Structure Compliance
      ‚úì should process a valid request and return a valid response (9 ms)
      ‚úì should include correct jsonrpc version in all responses (3 ms)
      ‚úì should handle initialize request correctly (2 ms)
    JSON-RPC 2.0 Error Handling
      ‚úì should return Invalid Request (-32600) for missing jsonrpc field (2 ms)
      ‚úì should return Invalid Request (-32600) for wrong jsonrpc version (4 ms)
      ‚úì should return Invalid Request (-32600) for missing method field (2 ms)
      ‚úì should return Invalid Request (-32600) for non-string method (2 ms)
      ‚úì should return Method Not Found (-32601) error (1 ms)
      ‚úì should return Internal Error (-32603) for invalid params on tools/call (2 ms)
      ‚úì should handle null and undefined messages (2 ms)
      ‚úì should handle empty object message (2 ms)
      ‚úì should handle array message (not allowed) (4 ms)
    MCP Protocol Specific Validation
      ‚úì should handle tools/list request correctly (2 ms)
      ‚úì should handle prompts/list request correctly (1 ms)
      ‚úì should handle resources/list request correctly (1 ms)
      ‚úì should handle missing optional params field (1 ms)
      ‚úì should preserve request ID in response (2 ms)
      ‚úì should handle special characters in method names (2 ms)

 PASS  src/tools/__tests__/form-creation-tool.test.ts
  FormCreationTool
    constructor
      ‚úì should create an instance with correct name and description (1 ms)
      ‚úì should initialize all required services (1 ms)
    execute - template creation
      ‚úì should create form from template successfully (1 ms)
      ‚úì should create form from template without custom title (4 ms)
      ‚úì should throw error when template not found (6 ms)
    execute - natural language creation
      ‚úì should create form from natural language prompt successfully (1 ms)
      ‚úì should create form without custom title override (1 ms)
    execute - error scenarios
      ‚úì should throw error when neither templateId nor naturalLanguagePrompt provided
      ‚úì should propagate API errors from createForm (1 ms)
      ‚úì should handle both templateId and naturalLanguagePrompt (prioritize template)
    execute - edge cases
      ‚úì should handle empty string values gracefully (1 ms)
      ‚úì should handle null/undefined form URL from API (1 ms)
    logging
      ‚úì should log execution arguments

 PASS  src/middleware/__tests__/error-handler.test.ts
  Error Handler Middleware
    globalErrorHandler
      ‚úì should handle standard errors with default values (1 ms)
      ‚úì should handle structured errors (1 ms)
      ‚úì should include error details in non-production environment (1 ms)
      ‚úì should not include error details in production environment
      ‚úì should categorize network errors correctly (1 ms)
      ‚úì should categorize validation errors correctly
      ‚úì should categorize authentication errors correctly (1 ms)
      ‚úì should categorize authorization errors correctly (4 ms)
      ‚úì should categorize rate limit errors correctly
      ‚úì should categorize timeout errors correctly (as network errors due to categorization logic) (1 ms)
      ‚úì should categorize pure timeout errors correctly (1 ms)
      ‚úì should handle errors without messages
    asyncErrorHandler
      ‚úì should catch and pass async errors to next middleware (1 ms)
      ‚úì should handle successful async functions
      ‚úì should handle non-async functions that return values (1 ms)
    notFoundHandler
      ‚úì should create and pass a 404 structured error
      ‚úì should handle requests without requestId (1 ms)
    setupProcessErrorHandlers
      ‚úì should setup unhandledRejection and uncaughtException handlers (1 ms)
      ‚úì should setup handlers with custom logger
      ‚úì should handle unhandled rejection with logger (1 ms)
      ‚úì should handle unhandled rejection without logger
      ‚úì should handle uncaught exception with logger (15 ms)
      ‚úì should handle uncaught exception without logger (1 ms)

 PASS  src/__tests__/server.test.ts
  MCPServer Class Structure
    ‚úì should instantiate with default configuration (1 ms)
    ‚úì should accept custom configuration (1 ms)
    ‚úì should merge custom config with defaults (1 ms)
    ‚úì should have correct initial state
    ‚úì should handle server lifecycle methods (2 ms)
    ‚úì should return immutable config copy
  Default Configuration
    ‚úì should have sensible defaults (6 ms)
  ServerState Enum
    ‚úì should have all expected states

 PASS  src/__tests__/error-handling-logging.test.ts
  Error Handling and Logging Infrastructure
    Structured Logging
      ‚úì should support different log levels (6 ms)
      ‚úì should redact sensitive information (1 ms)
      ‚úì should respect log level configuration
    Error Metrics
      ‚úì should track error metrics (1 ms)
      ‚úì should initialize with zero errors (1 ms)
    Logger Configuration
      ‚úì should merge logger config with defaults
      ‚úì should have appropriate sensitive fields configured (1 ms)
    Error Categories
      ‚úì should have all required error categories (1 ms)
    Integration with Health Monitoring
      ‚úì should integrate error metrics with health monitoring (4 ms)
    Request Context Preservation
      ‚úì should handle request ID generation (2 ms)
    Server State Integration
      ‚úì should maintain consistent state with enhanced logging (1 ms)
    Backward Compatibility
      ‚úì should maintain compatibility with existing functionality (1 ms)
      ‚úì should support debug mode configuration (1 ms)

 PASS  src/tools/__tests__/form-modification-tool.test.ts
  FormModificationTool
    constructor
      ‚úì should create an instance with correct name and description (1 ms)
      ‚úì should initialize with TallyApiService
    execute
      ‚úì should return error when formId is not provided (1 ms)
      ‚úì should return error when form is not found
      ‚úì should successfully retrieve form when it exists (1 ms)
      ‚úì should handle API errors gracefully
    getForm
      ‚úì should return form when API call succeeds
      ‚úì should return null when API call fails
    getForms
      ‚úì should return forms list when API call succeeds (1 ms)
      ‚úì should pass options to API service (7 ms)
      ‚úì should return null when API call fails (1 ms)
    updateForm
      ‚úì should return updated form when API call succeeds
      ‚úì should return null when API call fails (1 ms)
    patchForm
      ‚úì should return patched form when API call succeeds
      ‚úì should return null when API call fails
    validateConnection
      ‚úì should return true when connection is valid (1 ms)
      ‚úì should return false when connection fails
      ‚úì should return false when API returns null (1 ms)

 PASS  src/services/__tests__/form-modification-parser.test.ts
  FormModificationParser
    Add Field Commands
      ‚úì should parse "add text field" command (1 ms)
      ‚úì should parse "add a new email field" command (1 ms)
      ‚úì should parse "add phone number field" command
      ‚úì should handle unknown field types
    Remove Field Commands
      ‚úì should parse "remove question 3" command (1 ms)
      ‚úì should parse "delete field number 5" command (1 ms)
      ‚úì should parse "remove the email field" command
    Requirement Commands
      ‚úì should parse "make field 2 required" command (1 ms)
      ‚úì should parse "make the email field required" command
      ‚úì should parse "make question 1 optional" command (1 ms)
    Form Update Commands
      ‚úì should parse update title command (1 ms)
      ‚úì should parse update description command (3 ms)
    Reorder Commands
      ‚úì should parse "move field 3 to position 1" command (1 ms)
      ‚úì should parse "move question 2 to 5" command
    Option Commands
      ‚úì should parse add option command (1 ms)
    Ambiguous Commands
      ‚úì should handle completely unknown commands
      ‚úì should detect low confidence commands as ambiguous (1 ms)
    Multiple Commands
      ‚úì should parse multiple commands separated by "and"
      ‚úì should parse multiple commands separated by commas (1 ms)
      ‚úì should parse multiple commands separated by "then"
    Clarification Features
      ‚úì should need clarification for low confidence commands
      ‚úì should generate suggestions for add commands (1 ms)
      ‚úì should generate suggestions for required commands
      ‚úì should generate suggestions for remove commands
    Field Type Mapping
      ‚úì should map "text" to correct QuestionType (1 ms)
      ‚úì should map "input" to correct QuestionType
      ‚úì should map "textarea" to correct QuestionType
      ‚úì should map "long text" to correct QuestionType
      ‚úì should map "email" to correct QuestionType
      ‚úì should map "email address" to correct QuestionType (1 ms)
      ‚úì should map "number" to correct QuestionType
      ‚úì should map "numeric" to correct QuestionType (1 ms)
      ‚úì should map "phone" to correct QuestionType
      ‚úì should map "phone number" to correct QuestionType (2 ms)
      ‚úì should map "url" to correct QuestionType
      ‚úì should map "website" to correct QuestionType (1 ms)
      ‚úì should map "date" to correct QuestionType
      ‚úì should map "time" to correct QuestionType
      ‚úì should map "rating" to correct QuestionType (1 ms)
      ‚úì should map "stars" to correct QuestionType
      ‚úì should map "file" to correct QuestionType
      ‚úì should map "upload" to correct QuestionType
      ‚úì should map "signature" to correct QuestionType
      ‚úì should map "choice" to correct QuestionType
      ‚úì should map "multiple choice" to correct QuestionType
      ‚úì should map "select" to correct QuestionType (1 ms)
      ‚úì should map "dropdown" to correct QuestionType
      ‚úì should map "checkboxes" to correct QuestionType
      ‚úì should map "scale" to correct QuestionType (1 ms)
    Case Insensitivity
      ‚úì should parse commands regardless of case

 PASS  src/services/__tests__/form-publication-service.test.ts
  FormPublicationService
    getPublicationSettings
      ‚úì should return default publication settings for a form (2 ms)
    updatePublicationSettings
      ‚úì should update publication settings for a form (1 ms)
    publishForm
      ‚úì should publish a form with default public visibility
      ‚úì should publish a form with password protection
    unpublishForm
      ‚úì should unpublish a form (1 ms)
    generateEmbedCode
      ‚úì should generate embed code with default settings (1 ms)
      ‚úì should generate embed code with custom settings (1 ms)
    generateShareLink
      ‚úì should generate a standard share link (1 ms)
      ‚úì should generate a password-protected share link with expiration (4 ms)
      ‚úì should generate a share link with custom slug (1 ms)
    getShareLinks
      ‚úì should return empty array for forms with no share links (1 ms)
    updateShareLink
      ‚úì should update a share link (1 ms)
    deactivateShareLink
      ‚úì should deactivate a share link (1 ms)
    getFormSharingStats
      ‚úì should return default sharing statistics (1 ms)
    getFormAnalytics
      ‚úì should return analytics data for different periods (1 ms)
    performBulkOperation
      ‚úì should perform bulk publish operation (1 ms)
      ‚úì should handle bulk operation failures (1 ms)
    validateFormForPublication
      ‚úì should validate a form successfully (1 ms)
      ‚úì should return validation errors for invalid form
      ‚úì should handle form not found (1 ms)
      ‚úì should handle API errors gracefully

 PASS  src/config/__tests__/env.test.ts
  Environment Configuration
    ‚úì should successfully parse valid environment variables (3 ms)
    ‚úì should use default NODE_ENV when not provided (3 ms)
    ‚úì should accept test environment (2 ms)
    ‚úì should accept development environment (2 ms)
    ‚úì should throw error when TALLY_API_KEY is missing (9 ms)
    ‚úì should throw error when TALLY_API_KEY is empty (3 ms)
    ‚úì should throw error when CLOUDFLARE_ACCOUNT_ID is missing (2 ms)
    ‚úì should throw error when CLOUDFLARE_ACCOUNT_ID is empty (3 ms)
    ‚úì should throw error when CLOUDFLARE_API_TOKEN is missing (2 ms)
    ‚úì should throw error when CLOUDFLARE_API_TOKEN is empty (3 ms)
    ‚úì should throw error when NODE_ENV is invalid (2 ms)
    ‚úì should throw error when all required variables are missing (2 ms)
    ‚úì should handle extra environment variables gracefully (3 ms)

 PASS  src/tools/__tests__/template-tool.test.ts
  TemplateTool
    execute
      ‚úì should call listTemplates for the 'list' action (4 ms)
      ‚úì should call useTemplate for the 'use' action (1 ms)
      ‚úì should call customizeTemplate for the 'customize' action (1 ms)
      ‚úì should return an error if templateId is missing for the 'use' action
      ‚úì should return an error for an invalid action (1 ms)

 PASS  src/__tests__/api/errors.test.ts
  Tally API Client - Error Handling
    ‚úì should handle 401 Unauthorized errors (20 ms)
    ‚úì should handle 403 Forbidden errors
    ‚úì should handle 404 Not Found errors
    ‚úì should handle 422 Unprocessable Entity errors (1 ms)
    ‚úì should handle 429 Rate Limit errors
    ‚úì should handle 500 Server errors (1 ms)

 PASS  src/tools/__tests__/submission-tool.test.ts
  SubmissionAnalysisTool
    filterByDateRange
      ‚úì should call SubmissionService.getFormSubmissions with the correct date range (1 ms)
      ‚úì should return the submissions from the service
    filterByStatus
      ‚úì should call SubmissionService.getFormSubmissions with the correct status (3 ms)
      ‚úì should return the submissions from the service (1 ms)
    analyze
      ‚úì should correctly analyze the submissions response
    formatForAnalysis
      ‚úì should correctly format submissions for analysis
    getAverageRating
      ‚úì should calculate the average rating for a numeric question
      ‚úì should return null if no numeric ratings are found
    getResponseDistribution
      ‚úì should calculate the response distribution for a question (1 ms)
    exportToCSV
      ‚úì should export formatted submissions to a CSV file (2 ms)
    exportToJSON
      ‚úì should export formatted submissions to a JSON file
    search
      ‚úì should return submissions matching the search query (1 ms)

 PASS  src/tools/__tests__/form-permission-manager.test.ts
  FormPermissionManager
    setFormPermission
      ‚úì should call FormPermissionService.setFormPermission with correct parameters (4 ms)
    updateFormPermission
      ‚úì should call FormPermissionService.updateFormPermission with correct parameters (1 ms)
    removeFormPermission
      ‚úì should call FormPermissionService.removeFormPermission and return success status
    setBulkFormPermissions
      ‚úì should create bulk permission object and call service (1 ms)
    getEffectivePermission
      ‚úì should get workspace details and call service with workspace role (1 ms)
    canPerformAction
      ‚úì should validate access and return boolean result
    inheritWorkspacePermissions
      ‚úì should map workspace role to access level (1 ms)
    overrideWorkspaceInheritance
      ‚úì should set form permission with inheritFromWorkspace false
    getFormPermissionSummary
      ‚úì should combine permissions and settings into a summary (1 ms)

 PASS  src/config/__tests__/wrangler-config.test.ts
  Wrangler Configuration
    getWranglerConfig
      ‚úì should successfully parse valid wrangler.toml (4 ms)
      ‚úì should successfully parse minimal valid wrangler.toml
      ‚úì should use custom path when provided (1 ms)
      ‚úì should throw error when file cannot be read (5 ms)
      ‚úì should throw error when TOML is invalid (1 ms)
      ‚úì should throw error when name is missing (1 ms)
      ‚úì should throw error when name is empty
      ‚úì should throw error when compatibility_date is missing (1 ms)
      ‚úì should throw error when compatibility_date format is invalid (1 ms)
      ‚úì should throw error when kv_namespaces binding is missing (1 ms)
      ‚úì should throw error when kv_namespaces id is missing (1 ms)
      ‚úì should warn when secrets are defined in plaintext (1 ms)
      ‚úì should not warn when no secrets are in plaintext
      ‚úì should handle secrets array correctly
      ‚úì should handle multiple kv_namespaces (1 ms)

 PASS  src/services/__tests__/form-modification-operations.test.ts
  FormModificationOperations
    executeOperation
      ‚úì should handle unknown operation types (1 ms)
      ‚úì should handle errors gracefully
    ADD_FIELD operation
      ‚úì should add a text field successfully (1 ms)
      ‚úì should add a choice field with options (1 ms)
      ‚úì should generate default label when not provided
      ‚úì should fail when field type is missing (1 ms)
    REMOVE_FIELD operation
      ‚úì should remove field by number
      ‚úì should remove field by label (1 ms)
      ‚úì should fail when field is not found (1 ms)
    MAKE_REQUIRED/MAKE_OPTIONAL operations
      ‚úì should make field required
      ‚úì should make field optional (4 ms)
    UPDATE_TITLE operation
      ‚úì should update form title (1 ms)
      ‚úì should fail when new title is missing
    UPDATE_DESCRIPTION operation
      ‚úì should update form description (1 ms)
    REORDER_FIELD operation
      ‚úì should reorder field successfully
      ‚úì should fail with invalid source position (1 ms)
    ADD_OPTION operation
      ‚úì should add option to choice field
      ‚úì should fail when adding option to non-choice field (1 ms)
      ‚úì should fail when option text is missing
    MODIFY_FIELD operation
      ‚úì should modify field label
      ‚úì should modify multiple field properties (1 ms)
      ‚úì should fail when no modifications are specified
    validateFormConfig
      ‚úì should validate valid form configuration (1 ms)
      ‚úì should detect duplicate field IDs
      ‚úì should detect empty field labels
      ‚úì should detect choice fields without options (1 ms)

 PASS  src/tools/__tests__/workspace-tool.test.ts
  WorkspaceManagementTool
    listWorkspaces
      ‚úì should call WorkspaceService.getWorkspaces and return the result (1 ms)
    getWorkspaceDetails
      ‚úì should call WorkspaceService.getWorkspace and return the result (1 ms)
    inviteUserToWorkspace
      ‚úì should call WorkspaceService.inviteUser with the correct parameters (1 ms)
    removeUserFromWorkspace
      ‚úì should call WorkspaceService.removeUser with the correct parameters
    updateUserRoleInWorkspace
      ‚úì should call WorkspaceService.updateUserRole with the correct parameters (4 ms)

 PASS  src/services/__tests__/template-service.test.ts
  TemplateService
    getTemplates
      ‚úì should return all available templates (1 ms)
    findTemplateById
      ‚úì should find a template by its ID
      ‚úì should return undefined for a non-existent template ID (1 ms)
    instantiateTemplate
      ‚úì should instantiate a form from a template
      ‚úì should override the title if a custom title is provided (4 ms)
      ‚úì should return undefined for a non-existent template ID
      ‚úì should create a deep copy of the form configuration (1 ms)
    createTemplate
      ‚úì should create a new template and add it to the registry
    updateTemplate
      ‚úì should update an existing template
      ‚úì should return undefined for a non-existent template ID
    deleteTemplate
      ‚úì should delete an existing template (1 ms)
      ‚úì should return false for a non-existent template ID

 PASS  src/services/__tests__/workspace-service.test.ts
  WorkspaceService
    getWorkspaces
      ‚úì should call TallyApiClient.getWorkspaces and return the result (4 ms)
    getWorkspace
      ‚úì should call TallyApiClient.getWorkspace and return the result (1 ms)
    inviteUser
      ‚úì should call TallyApiClient.inviteUserToWorkspace with the correct parameters (1 ms)
    removeUser
      ‚úì should call TallyApiClient.removeUserFromWorkspace with the correct parameters
    updateUserRole
      ‚úì should call TallyApiClient.updateUserRole with the correct parameters (1 ms)

 PASS  src/__tests__/TallyApiClient.integration.test.ts
  TallyApiClient Integration Tests
    Retry Configuration Integration
      ‚úì should initialize with default retry configuration
      ‚úì should accept custom retry configuration
      ‚úì should merge partial retry configuration with defaults
      ‚úì should have interceptors set up when retry config is provided (1 ms)
      ‚úì should maintain backward compatibility when no retry config is provided
    Error Handling Configuration
      ‚úì should have proper error types available for retry logic
      ‚úì should create client with debug logging enabled
    Circuit Breaker Configuration
      ‚úì should configure circuit breaker with custom settings
      ‚úì should allow disabling circuit breaker (1 ms)

 PASS  src/services/__tests__/nlp-service.test.ts
  NlpService
    customizeFormConfig
      ‚úì should add a new question to the form (1 ms)
      ‚úì should remove an existing question from the form (1 ms)
      ‚úì should update the form title
      ‚úì should handle multiple commands

 PASS  src/__tests__/api/forms.test.ts
  Tally API Client - Forms
    ‚úì should fetch forms and validate the response (1 ms)
    ‚úì should fetch a single form and validate the response (1 ms)
    ‚úì should fetch form submissions and validate the response

 PASS  src/services/__tests__/matrix-question.test.ts
  Matrix Question Support
    Matrix Question Creation
      ‚úì should create a matrix question with default configuration (1 ms)
      ‚úì should include matrix in choice field types
      ‚úì should generate appropriate default label for matrix questions (1 ms)
    Matrix Question Structure
      ‚úì should have properly structured rows and columns

 PASS  src/__tests__/api/workspace-and-user.test.ts
  Tally API Client - Workspaces and User
    ‚úì should fetch workspaces and validate the response (1 ms)
    ‚úì should fetch a single workspace and validate the response (1 ms)

 PASS  src/__tests__/network-resilience-timeout.test.ts
  Network Resilience and Timeout
    ‚úì should have tests (1 ms)

----------------------------------|---------|----------|---------|---------|--------------------------------------
File                              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s

----------------------------------|---------|----------|---------|---------|--------------------------------------
All files                         |   55.92 |    42.71 |   54.86 |   56.37 |

 src                              |   58.17 |    32.81 |    70.1 |   58.35 |

  index.ts                        |   86.95 |       80 |      80 |   86.36 | 51-53

  server.ts                       |   74.66 |       50 |   78.48 |      75 | ...707-1729,1749,1767,1772-1778,1786 
  worker.ts                       |   16.49 |     4.95 |   15.38 |   16.66 | ...046,1052-1055,1062-1063,1070-1071 
 src/config                       |     100 |      100 |     100 |     100 |

  env.ts                          |     100 |      100 |     100 |     100 |

  wrangler-config.ts              |     100 |      100 |     100 |     100 |

 src/middleware                   |   79.12 |     79.2 |   69.52 |   78.41 |

  api-key-auth.ts                 |   86.32 |    71.69 |   73.33 |   87.87 | ...2,116,120,187-189,236,240,258-265 
  error-handler.ts                |   98.36 |    94.59 |     100 |   98.33 | 198

  index.ts                        |       0 |      100 |       0 |       0 | 13-38

  rateLimiter.example.ts          |       0 |      100 |       0 |       0 | 1-70

  rateLimiter.ts                  |   86.76 |       60 |   86.66 |   85.24 | 10-24,128

  sanitization.ts                 |   71.05 |       80 |   63.63 |   70.27 | 68,138-155,183

  security.ts                     |   77.63 |    71.73 |     100 |   77.02 | 27,57,229-235,240-246,272-289

  validation.ts                   |   88.46 |    89.09 |   76.92 |   87.75 | ...6,101,119-135,186,196,218-222,270 
 src/models                       |   60.49 |    29.18 |   27.69 |   64.42 |

  api-key.ts                      |     100 |      100 |     100 |     100 |

  errors.ts                       |   40.65 |    28.57 |      35 |   43.75 | ...5,216-225,238-242,255-259,277,307 
  form-config-schemas.ts          |   77.31 |        0 |       0 |   78.12 | ...5,585,594,604-606,616-617,628-641 
  form-config.ts                  |   49.83 |    24.52 |   20.89 |   54.34 | ...523,1530,1540-1543,1559,1591,1624 
  form-sharing-models.ts          |     100 |      100 |     100 |     100 |

  form-version.ts                 |    3.84 |        0 |       0 |    4.34 | 32-107

  index.ts                        |     100 |      100 |   88.88 |     100 |

  tally-schemas.ts                |   86.36 |      100 |   14.28 |   92.68 | 505,514,523

  team-models.ts                  |     100 |      100 |     100 |     100 |

  template.ts                     |     100 |      100 |     100 |     100 |

 src/services                     |   43.65 |    32.45 |   52.53 |   43.65 |

  TallyApiClient.ts               |   36.11 |    39.34 |   62.22 |   37.44 | ...899-946,957-982,990-996,1005-1022 
  TokenManager.ts                 |    3.44 |        0 |       0 |    3.44 | 25-36,58-230

  api-key-service.ts              |   73.68 |    72.83 |   79.48 |   75.31 | ...9,378,406,440,445,451-454,499-523 
  authentication-validator.ts     |       0 |        0 |       0 |       0 | 1-2108

  form-modification-operations.ts |   77.24 |    50.88 |   73.33 |   78.19 | ...9,918,933-993,1038-1046,1071,1074 
  form-modification-parser.ts     |     100 |    78.57 |     100 |     100 | 205-322

  form-permission-service.ts      |   11.53 |        0 |       0 |   11.53 | 25-217

  form-publication-service.ts     |   77.77 |    64.17 |     100 |   79.86 | ...8,496,546,549-550,563-565,575-579 
  index.ts                        |     100 |      100 |     100 |     100 |

  nlp-service.ts                  |   69.01 |    42.85 |      60 |   71.21 | 55-77,94,103,111-112,124-134

  submission-service.ts           |   42.85 |        0 |       0 |   42.85 | 12-36

  tally-api-service.ts            |    9.09 |        0 |       0 |   10.25 | 9-154

  team-service.ts                 |    3.38 |        0 |       0 |     3.5 | 35-397

  template-service.ts             |     100 |      100 |     100 |     100 |

  workspace-service.ts            |     100 |       50 |     100 |     100 | 11

 src/tools                        |   79.52 |    64.81 |   76.57 |    79.1 |

  form-creation-tool.ts           |     100 |      100 |     100 |     100 |

  form-modification-tool.ts       |    93.1 |    66.66 |     100 |    93.1 | 81,144

  form-permission-manager.ts      |   91.17 |       25 |   83.33 |    90.9 | 130,147-158

  form-sharing-tool.ts            |   97.64 |    64.51 |     100 |   97.53 | 215-217

  index.ts                        |     100 |      100 |      25 |     100 |

  submission-tool.ts              |   95.08 |       75 |     100 |   94.82 | 112,131,143

  team-manager.ts                 |   36.27 |    58.33 |   46.87 |   35.41 | 90-91,214-393,412-457

  template-tool.ts                |   88.88 |       70 |     100 |   88.88 | 48,80,98

  workspace-tool.ts               |     100 |       50 |     100 |     100 | 12

 src/types                        |     100 |      100 |     100 |     100 |

  capabilities.ts                 |     100 |      100 |     100 |     100 |

  errors.ts                       |     100 |      100 |     100 |     100 |

  toml.d.ts                       |       0 |        0 |       0 |       0 |

 src/utils                        |   91.48 |    74.35 |   84.09 |    92.1 |

  capability-negotiation.ts       |   93.75 |     67.9 |     100 |   93.61 | 125,130,136

  config.ts                       |   93.33 |      100 |     100 |   92.85 | 137-138

  crypto.ts                       |   96.55 |    82.85 |     100 |   96.55 | 243,258,263

  index.ts                        |       0 |      100 |       0 |       0 | 13-21

  input-sanitizer.ts              |   95.08 |    76.47 |     100 |   94.91 | 60,76,102

 src/validation                   |   25.66 |    36.44 |   22.78 |   26.24 |

  constants.ts                    |    12.3 |        0 |       0 |    12.3 | 66-313

  demo.ts                         |       0 |        0 |       0 |       0 | 8-213

  index.ts                        |       0 |      100 |       0 |       0 | 8-25

  mcp-tool-validator.ts           |       0 |        0 |       0 |       0 | 7-292

  schema-validator.ts             |   98.61 |    91.89 |     100 |   98.61 | 256

  types.ts                        |   88.88 |       50 |      50 |   88.88 | 151

  validate-project-tools.ts       |       0 |        0 |       0 |       0 | 8-341

  validation-reporter.ts          |       0 |        0 |       0 |       0 | 12-327

  validation-utils.ts             |     100 |      100 |     100 |     100 |

----------------------------------|---------|----------|---------|---------|--------------------------------------
Jest: "global" coverage threshold for statements (90%) not met: 55.92%
Jest: "global" coverage threshold for branches (90%) not met: 42.71%
Jest: "global" coverage threshold for lines (90%) not met: 56.37%
Jest: "global" coverage threshold for functions (90%) not met: 54.86%
Summary of all failing tests
 FAIL  src/__tests__/sse-connection-handshake.test.ts (38.225 s)
  ‚óè SSE Connection Establishment and MCP Handshake Testing ‚Ä∫ Basic SSE Connection Establishment ‚Ä∫ should maintain 
heartbeat mechanism

    Event heartbeat not received within 35000ms

      137 |       await new Promise(resolve => setTimeout(resolve, 50));
      138 |     }
    > 139 |     throw new Error(`Event ${eventType} not received within ${timeout}ms`);
          |           ^
      140 |   }
      141 |
      142 |   on(event: string, listener: (...args: any[]) => void): void {

      at MockMCPClient.waitForEvent (src/__tests__/sse-connection-handshake.test.ts:139:11)
      at Object.<anonymous> (src/__tests__/sse-connection-handshake.test.ts:281:30)

 FAIL  src/__tests__/capability-negotiation.test.ts (15.403 s)
  ‚óè MCP Capability Negotiation ‚Ä∫ Protocol Version Negotiation ‚Ä∫ should reject unsupported protocol version

    expect(received).toBeDefined()

    Received: undefined

      197 |       });
      198 |
    > 199 |       expect(response.error).toBeDefined();
          |                              ^
      200 |       expect(response.error.code).toBe(-32600);
      201 |       expect(response.error.message).toContain('Unsupported protocol version');
      202 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:199:30)

  ‚óè MCP Capability Negotiation ‚Ä∫ Protocol Version Negotiation ‚Ä∫ should handle missing protocol version

    expect(received).toBeDefined()

    Received: undefined

      214 |       });
      215 |
    > 216 |       expect(response.error).toBeDefined();
          |                              ^
      217 |       expect(response.error.code).toBe(-32602);
      218 |       expect(response.error.message).toContain('Protocol version is required');
      219 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:216:30)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Discovery ‚Ä∫ should advertise supported capabilities in SSE connection

    Timeout waiting for event connection

       99 |     return new Promise((resolve, reject) => {
      100 |       const timeoutId = setTimeout(() => {
    > 101 |         reject(new Error(`Timeout waiting for event ${eventType}`));
          |                ^
      102 |       }, timeout);
      103 |
      104 |       const handler = (event: any) => {

      at Timeout._onTimeout (src/__tests__/capability-negotiation.test.ts:101:16)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should notify clients when tool list changes

    Unhandled error. (Error: SSE connection error

      53 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
      54 |         this.connected = false;
    > 55 |         const error = new Error('SSE connection error');
         |                       ^
      56 |         (error as any).event = errorEvent;
      57 |         this.events.push({ type: 'error', data: JSON.stringify(errorEvent) });
      58 |         this.eventEmitter.emit('error', error);

      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:55:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)
      at processTicksAndRejections (node:internal/process/task_queues:82:21) {
        event: Event { type: 'error', message: undefined }
      })
      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:58:27)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should notify clients when tool list changes

    Timeout waiting for event mcp-response

       99 |     return new Promise((resolve, reject) => {
      100 |       const timeoutId = setTimeout(() => {
    > 101 |         reject(new Error(`Timeout waiting for event ${eventType}`));
          |                ^
      102 |       }, timeout);
      103 |
      104 |       const handler = (event: any) => {

      at Timeout._onTimeout (src/__tests__/capability-negotiation.test.ts:101:16)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should maintain capability state across reconnections

    Unhandled error. (Error: SSE connection error

      53 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
      54 |         this.connected = false;
    > 55 |         const error = new Error('SSE connection error');
         |                       ^
      56 |         (error as any).event = errorEvent;
      57 |         this.events.push({ type: 'error', data: JSON.stringify(errorEvent) });
      58 |         this.eventEmitter.emit('error', error);

      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:55:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)
      at processTicksAndRejections (node:internal/process/task_queues:82:21) {
        event: Event { type: 'error', message: undefined }
      })
      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:58:27)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)

  ‚óè MCP Capability Negotiation ‚Ä∫ Capability Updates ‚Ä∫ should maintain capability state across reconnections

    Timeout waiting for event connection

       99 |     return new Promise((resolve, reject) => {
      100 |       const timeoutId = setTimeout(() => {
    > 101 |         reject(new Error(`Timeout waiting for event ${eventType}`));
          |                ^
      102 |       }, timeout);
      103 |
      104 |       const handler = (event: any) => {

      at Timeout._onTimeout (src/__tests__/capability-negotiation.test.ts:101:16)

  ‚óè MCP Capability Negotiation ‚Ä∫ Error Handling ‚Ä∫ should handle malformed capability objects

    expect(received).toBeDefined()

    Received: undefined

      386 |       });
      387 |
    > 388 |       expect(response.error).toBeDefined();
          |                              ^
      389 |       expect(response.error.code).toBe(-32602);
      390 |       expect(response.error.message).toContain('Invalid capabilities format');
      391 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:388:30)

  ‚óè MCP Capability Negotiation ‚Ä∫ Error Handling ‚Ä∫ should handle invalid capability values

    expect(received).toBeDefined()

    Received: undefined

      408 |       });
      409 |
    > 410 |       expect(response.error).toBeDefined();
          |                              ^
      411 |       expect(response.error.code).toBe(-32602);
      412 |       expect(response.error.message).toContain('Invalid capability values');
      413 |     });

      at Object.<anonymous> (src/__tests__/capability-negotiation.test.ts:410:30)


  ‚óè Test suite failed to run

    Unhandled error. (Error: SSE connection error

      53 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
      54 |         this.connected = false;
    > 55 |         const error = new Error('SSE connection error');
         |                       ^
      56 |         (error as any).event = errorEvent;
      57 |         this.events.push({ type: 'error', data: JSON.stringify(errorEvent) });
      58 |         this.eventEmitter.emit('error', error);

      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:55:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)
      at processTicksAndRejections (node:internal/process/task_queues:82:21) {
        event: Event { type: 'error', message: undefined }
      })
      at EventSource.eventSource.onerror (src/__tests__/capability-negotiation.test.ts:58:27)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at onConnectionClosed (node_modules/eventsource/lib/eventsource.js:58:5)
      at IncomingMessage.<anonymous> (node_modules/eventsource/lib/eventsource.js:187:9)

 FAIL  src/utils/__tests__/crypto.test.ts (10.202 s)
  ‚óè CryptoUtils ‚Ä∫ Temporary Token ‚Ä∫ should fail verification for an expired token

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      150 |         setTimeout(() => {
      151 |             const result = CryptoUtils.verifyTempToken(token);
    > 152 |             expect(result.valid).toBe(false);
          |                                  ^
      153 |             expect(result.error).toBe('Token expired');
      154 |             done();
      155 |         }, 1100);

      at Timeout._onTimeout (src/utils/__tests__/crypto.test.ts:152:34)

  ‚óè CryptoUtils ‚Ä∫ Temporary Token ‚Ä∫ should fail verification for an expired token

    thrown: "Exceeded timeout of 10000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.i
o/docs/api#testname-fn-timeout."

      145 |     });
      146 |
    > 147 |     it('should fail verification for an expired token', (done) => {
          |     ^
      148 |         const payload = { userId: 'user-123' };
      149 |         const token = CryptoUtils.generateTempToken(payload, 1); // 1 second expiry
      150 |         setTimeout(() => {

      at src/utils/__tests__/crypto.test.ts:147:5
      at src/utils/__tests__/crypto.test.ts:125:3
      at Object.<anonymous> (src/utils/__tests__/crypto.test.ts:5:1)

  ‚óè CryptoUtils ‚Ä∫ Other Utilities ‚Ä∫ should mask sensitive data

    expect(received).toBe(expected) // Object.is equality

    Expected: "******7890"
    Received: "1234**7890"

      171 |     it('should mask sensitive data', () => {
      172 |         const sensitive = '1234567890';
    > 173 |         expect(CryptoUtils.maskSensitiveData(sensitive)).toBe('******7890');
          |                                                          ^
      174 |         expect(CryptoUtils.maskSensitiveData(sensitive, 2)).toBe('********90');
      175 |         expect(CryptoUtils.maskSensitiveData('abc')).toBe('abc');
      176 |     });

      at Object.<anonymous> (src/utils/__tests__/crypto.test.ts:173:58)

 FAIL  src/__tests__/message-delivery-formatting.test.ts
  ‚óè Message Delivery and Formatting Verification ‚Ä∫ Error Handling and Edge Cases ‚Ä∫ should handle malformed JSON in
 requests gracefully

    SSE connection error

      54 |
      55 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
    > 56 |         const error = new Error('SSE connection error');
         |                       ^
      57 |         (error as any).event = errorEvent;
      58 |         this.connectionError = error;
      59 |         clearTimeout(timeoutId);

      at EventSource.eventSource.onerror (src/__tests__/message-delivery-formatting.test.ts:56:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at ClientRequest.<anonymous> (node_modules/eventsource/lib/eventsource.js:173:9)

  ‚óè Message Delivery and Formatting Verification ‚Ä∫ Error Handling and Edge Cases ‚Ä∫ should handle malformed JSON in
 responses

    SSE connection error

      54 |
      55 |       this.eventSource.onerror = (errorEvent: MessageEvent) => {
    > 56 |         const error = new Error('SSE connection error');
         |                       ^
      57 |         (error as any).event = errorEvent;
      58 |         this.connectionError = error;
      59 |         clearTimeout(timeoutId);

      at EventSource.eventSource.onerror (src/__tests__/message-delivery-formatting.test.ts:56:23)
      at _emit (node_modules/eventsource/lib/eventsource.js:287:17)
      at ClientRequest.<anonymous> (node_modules/eventsource/lib/eventsource.js:173:9)

  ‚óè Message Delivery and Formatting Verification ‚Ä∫ Error Handling and Edge Cases ‚Ä∫ should handle requests without 
required fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: undefined

      453 |         expect(true).toBe(false); // This should not be reached
      454 |       } catch (error: any) {
    > 455 |         expect(error.response?.status).toBe(400);
          |                                        ^
      456 |       }
      457 |     });
      458 |

      at Object.<anonymous> (src/__tests__/message-delivery-formatting.test.ts:455:40)

 FAIL  src/__tests__/TallyApiClient.test.ts
  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getSubmissions ‚Ä∫ should validate and return submi
ssions response

    expect(received).toEqual(expected) // deep equality

    - Expected  -   7
    + Received  + 204

    @@ -3,24 +3,221 @@
        "limit": 10,
        "page": 1,
        "questions": Array [],
        "submissions": Array [
          Object {
    -       "formId": "form_123",
    -       "id": "sub_1",
    +       "formId": "form_123456789",
    +       "id": "sub_000000001",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000001",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 1",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user1@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 1 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-12T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000002",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000002",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 2",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user2@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 2 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-11T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000003",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000003",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 3",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user3@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 3 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-10T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000004",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000004",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 4",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user4@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 4 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-09T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000005",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000005",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 5",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user5@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 5 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-08T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000006",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000006",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 6",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user6@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 6 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-07T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000007",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000007",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 7",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user7@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 7 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-06T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000008",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000008",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 8",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user8@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 8 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-05T20:27:06.364Z",
    +     },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000009",
            "isCompleted": true,
    -       "respondentId": "resp_1",
    +       "respondentId": "resp_000000009",
            "responses": Array [
              Object {
                "questionId": "q1",
    -           "value": "Test User",
    +           "value": "User 9",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user9@example.com",
              },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 9 from a test user.",
    +         },
            ],
    -       "submittedAt": "2025-06-13T20:27:06.257Z",
    +       "submittedAt": "2025-06-04T20:27:06.364Z",
          },
    +     Object {
    +       "formId": "form_123456789",
    +       "id": "sub_000000010",
    +       "isCompleted": true,
    +       "respondentId": "resp_000000010",
    +       "responses": Array [
    +         Object {
    +           "questionId": "q1",
    +           "value": "User 10",
    +         },
    +         Object {
    +           "questionId": "q2",
    +           "value": "user10@example.com",
    +         },
    +         Object {
    +           "questionId": "q3",
    +           "value": "This is message 10 from a test user.",
    +         },
    +       ],
    +       "submittedAt": "2025-06-03T20:27:06.364Z",
    +     },
        ],
        "totalNumberOfSubmissionsPerFilter": Object {
    -     "all": 1,
    -     "completed": 1,
    +     "all": 10,
    +     "completed": 10,
          "partial": 0,
        },
      }

      479 |         const result = await client.getSubmissions('form123', { page: 1, limit: 10 });
      480 |
    > 481 |         expect(result).toEqual(validSubmissionsData);
          |                        ^
      482 |         expect(mockAxiosInstance.request).toHaveBeenCalledWith({
      483 |           method: 'GET',
      484 |           url: '/forms/form123/submissions?page=1&limit=10',

      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:481:24)

  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getSubmissions ‚Ä∫ should throw validation error fo
r invalid submissions response

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"hasMore": false, "limit": 10, "page": 1, "questions": [], "submissions": [{"formId": "for
m_123456789", "id": "sub_000000001", "isCompleted": true, "respondentId": "resp_000000001", "responses": [{"questi
onId": "q1", "value": "User 1"}, {"questionId": "q2", "value": "user1@example.com"}, {"questionId": "q3", "value":
 "This is message 1 from a test user."}], "submittedAt": "2025-06-12T20:27:06.471Z"}, {"formId": "form_123456789",
 "id": "sub_000000002", "isCompleted": true, "respondentId": "resp_000000002", "responses": [{"questionId": "q1",
"value": "User 2"}, {"questionId": "q2", "value": "user2@example.com"}, {"questionId": "q3", "value": "This is mes
sage 2 from a test user."}], "submittedAt": "2025-06-11T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_0
00000003", "isCompleted": true, "respondentId": "resp_000000003", "responses": [{"questionId": "q1", "value": "Use
r 3"}, {"questionId": "q2", "value": "user3@example.com"}, {"questionId": "q3", "value": "This is message 3 from a
 test user."}], "submittedAt": "2025-06-10T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000004", "i
sCompleted": true, "respondentId": "resp_000000004", "responses": [{"questionId": "q1", "value": "User 4"}, {"ques
tionId": "q2", "value": "user4@example.com"}, {"questionId": "q3", "value": "This is message 4 from a test user."}
], "submittedAt": "2025-06-09T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000005", "isCompleted":
true, "respondentId": "resp_000000005", "responses": [{"questionId": "q1", "value": "User 5"}, {"questionId": "q2"
, "value": "user5@example.com"}, {"questionId": "q3", "value": "This is message 5 from a test user."}], "submitted
At": "2025-06-08T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000006", "isCompleted": true, "respon
dentId": "resp_000000006", "responses": [{"questionId": "q1", "value": "User 6"}, {"questionId": "q2", "value": "u
ser6@example.com"}, {"questionId": "q3", "value": "This is message 6 from a test user."}], "submittedAt": "2025-06
-07T20:27:06.471Z"}, {"formId": "form_123456789", "id": "sub_000000007", "isCompleted": true, "respondentId": "res
p_000000007", "responses": [{"questionId": "q1", "value": "User 7"}, {"questionId": "q2", "value": "user7@example.
com"}, {"questionId": "q3", "value": "This is message 7 from a test user."}], "submittedAt": "2025-06-06T20:27:06.
471Z"}, {"formId": "form_123456789", "id": "sub_000000008", "isCompleted": true, "respondentId": "resp_000000008",
 "responses": [{"questionId": "q1", "value": "User 8"}, {"questionId": "q2", "value": "user8@example.com"}, {"ques
tionId": "q3", "value": "This is message 8 from a test user."}], "submittedAt": "2025-06-05T20:27:06.471Z"}, {"for
mId": "form_123456789", "id": "sub_000000009", "isCompleted": true, "respondentId": "resp_000000009", "responses":
 [{"questionId": "q1", "value": "User 9"}, {"questionId": "q2", "value": "user9@example.com"}, {"questionId": "q3"
, "value": "This is message 9 from a test user."}], "submittedAt": "2025-06-04T20:27:06.471Z"}, {"formId": "form_1
23456789", "id": "sub_000000010", "isCompleted": true, "respondentId": "resp_000000010", "responses": [{"questionI
d": "q1", "value": "User 10"}, {"questionId": "q2", "value": "user10@example.com"}, {"questionId": "q3", "value":
"This is message 10 from a test user."}], "submittedAt": "2025-06-03T20:27:06.471Z"}], "totalNumberOfSubmissionsPe
rFilter": {"all": 10, "completed": 10, "partial": 0}}

      502 |         mockAxiosInstance.request.mockResolvedValue(mockResponse);
      503 |
    > 504 |         await expect(
          |               ^
      505 |           client.getSubmissions('form123', { page: 1, limit: 10 }),
      506 |         ).rejects.toThrow();
      507 |       });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:504:15)

  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getForm ‚Ä∫ should validate and return form data

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "createdAt": "2025-06-13T20:27:06.473Z",
    +   "createdAt": "2024-01-01T00:00:00Z",
        "description": "Get in touch with our team",
        "embedUrl": "https://tally.so/embed/form_123456789",
        "id": "form123",
        "isPublished": true,
        "status": "published",
        "submissionsCount": 42,
        "title": "Contact Us",
    -   "updatedAt": "2025-06-13T20:27:06.473Z",
    +   "updatedAt": "2024-01-01T00:00:00Z",
        "url": "https://tally.so/r/form_123456789",
      }

      537 |         const result = await client.getForm('form123');
      538 |
    > 539 |         expect(result).toEqual(validFormData);
          |                        ^
      540 |         expect(mockAxiosInstance.request).toHaveBeenCalledWith({
      541 |           method: 'GET',
      542 |           url: '/forms/form123',

      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:539:24)

  ‚óè TallyApiClient ‚Ä∫ Type-Safe API Methods with Zod Validation ‚Ä∫ getForm ‚Ä∫ should throw validation error for inval
id form response

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"createdAt": "2024-01-01T00:00:00Z", "description": "Get in touch with our team", "embedUr
l": "https://tally.so/embed/form_123456789", "id": "form123", "isPublished": true, "status": "published", "submiss
ionsCount": 42, "title": "Contact Us", "updatedAt": "2024-01-01T00:00:00Z", "url": "https://tally.so/r/form_123456
789"}

      560 |         mockAxiosInstance.request.mockResolvedValue(mockResponse);
      561 |
    > 562 |         await expect(client.getForm('form123')).rejects.toThrow();
          |               ^
      563 |       });
      564 |     });
      565 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/TallyApiClient.test.ts:562:15)

 FAIL  src/middleware/__tests__/sanitization.test.ts
  ‚óè Sanitization Middleware ‚Ä∫ createSanitizationMiddleware ‚Ä∫ should sanitize body, query, and params by default

    expect(received).toBe(expected) // Object.is equality

    Expected: "alert(\"xss\")"
    Received: ""

      31 |       middleware(mockRequest as Request, mockResponse as Response, nextFunction);
      32 |
    > 33 |       expect(mockRequest.body.name).toBe('alert("xss")'); // Strips tags
         |                                     ^
      34 |       expect(mockRequest.body.email).toBe('test@test.com'); // Trims whitespace
      35 |       expect(mockRequest.query.search).toBe('&lt;p&gt;search term&lt;/p&gt;'); // Encodes HTML
      36 |       expect(mockRequest.params.id).toBe('123'); // Trims whitespace

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:33:37)

  ‚óè Sanitization Middleware ‚Ä∫ createSanitizationMiddleware ‚Ä∫ should handle nested objects

    expect(received).toBe(expected) // Object.is equality

    Expected: "&lt;p&gt;Test&lt;/p&gt;"
    Received: "  <p>Test</p>  "

      81 |         middleware(mockRequest as Request, mockResponse as Response, nextFunction);
      82 |
    > 83 |         expect(mockRequest.body.user.name).toBe('&lt;p&gt;Test&lt;/p&gt;');
         |                                            ^
      84 |         expect(nextFunction).toHaveBeenCalled();
      85 |     });
      86 |   });

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:83:44)

  ‚óè Sanitization Middleware ‚Ä∫ Pre-configured SanitizationMiddleware ‚Ä∫ SanitizationMiddleware.apiParams should use 
strict sanitization

    expect(received).toBe(expected) // Object.is equality

    Expected: "id"
    Received: ""

      90 |         mockRequest.body = { id: '<script>id</script>' };
      91 |         SanitizationMiddleware.apiParams(mockRequest as Request, mockResponse as Response, nextFunction
);
    > 92 |         expect(mockRequest.body.id).toBe('id');
         |                                     ^
      93 |     });
      94 |
      95 |     it('SanitizationMiddleware.formInput should allow some HTML', () => {

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:92:37)

  ‚óè Sanitization Middleware ‚Ä∫ Pre-configured SanitizationMiddleware ‚Ä∫ SanitizationMiddleware.formInput should allo
w some HTML

    expect(received).toBe(expected) // Object.is equality

    Expected: "<p>A nice comment.</p>bad"
    Received: "<p>A nice comment.</p>"

       96 |         mockRequest.body = { comment: '<p>A nice comment.</p><script>bad</script>' };
       97 |         SanitizationMiddleware.formInput(mockRequest as Request, mockResponse as Response, nextFunctio
n);
    >  98 |         expect(mockRequest.body.comment).toBe('<p>A nice comment.</p>bad');
          |                                          ^
       99 |     });
      100 |
      101 |     it('SanitizationMiddleware.richText should allow more formatting', () => {

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:98:42)

  ‚óè Sanitization Middleware ‚Ä∫ Pre-configured SanitizationMiddleware ‚Ä∫ SanitizationMiddleware.richText should allow
 more formatting

    expect(received).toBe(expected) // Object.is equality

    Expected: "<b>Bold</b> <a href=\"http://example.com\" rel=\"noopener noreferrer\">link</a>"
    Received: "<b>Bold</b> <a href=\"http://example.com\">link</a>"

      102 |         mockRequest.body = { article: '<b>Bold</b> <a href="http://example.com">link</a>' };
      103 |         SanitizationMiddleware.richText(mockRequest as Request, mockResponse as Response, nextFunction
);
    > 104 |         expect(mockRequest.body.article).toBe('<b>Bold</b> <a href="http://example.com" rel="noopener 
noreferrer">link</a>');
          |                                          ^
      105 |     });
      106 |   });
      107 |

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:104:42)

  ‚óè Sanitization Middleware ‚Ä∫ ManualSanitization ‚Ä∫ ManualSanitization.formData should sanitize object

    expect(received).toBe(expected) // Object.is equality

    Expected: "Name"
    Received: "<p>Name</p>"

      110 |         const dirty = { name: '<p>Name</p>', email: ' email@example.com ' };
      111 |         const clean = ManualSanitization.formData(dirty);
    > 112 |         expect(clean.name).toBe('Name');
          |                            ^
      113 |         expect(clean.email).toBe('email@example.com');
      114 |     });
      115 |

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:112:28)

  ‚óè Sanitization Middleware ‚Ä∫ ManualSanitization ‚Ä∫ ManualSanitization.logMessage should strip HTML and newlines

    expect(received).toBe(expected) // Object.is equality

    Expected: "Error: oops New line"
    Received: "Error:  New line"

      123 |         const dirty = 'Error: <script>oops</script>\nNew line';
      124 |         const clean = ManualSanitization.logMessage(dirty);
    > 125 |         expect(clean).toBe('Error: oops New line');
          |                       ^
      126 |     });
      127 |   });
      128 | }); 

      at Object.<anonymous> (src/middleware/__tests__/sanitization.test.ts:125:23)

 FAIL  src/__tests__/health-check.test.ts
  ‚óè Health Check Endpoint and Monitoring ‚Ä∫ Request Statistics Tracking ‚Ä∫ should track request counts

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      189 |       
      190 |       const updatedMetrics = server.getHealthMetrics();
    > 191 |       expect(updatedMetrics.requests.total).toBeGreaterThan(initialTotal);
          |                                             ^
      192 |     });
      193 |
      194 |     test('should track error counts', async () => {

      at Object.<anonymous> (src/__tests__/health-check.test.ts:191:45)

 FAIL  src/middleware/__tests__/security.test.ts
  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should block directory traversal attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 200

      189 |     it('should block directory traversal attempts', async () => {
      190 |       const response = await request(app).get('/test/../../../etc/passwd');
    > 191 |       expect(response.status).toBe(400);
          |                               ^
      192 |       expect(response.body.code).toBe('SECURITY_VIOLATION');
      193 |     });
      194 |

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:191:31)

  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should reject negative Content-Length

    expect(received).toBe(expected) // Object.is equality

    Expected: "INVALID_CONTENT_LENGTH"
    Received: undefined

      205 |         .send({ data: 'test' });
      206 |       expect(response.status).toBe(400);
    > 207 |       expect(response.body.code).toBe('INVALID_CONTENT_LENGTH');
          |                                  ^
      208 |     });
      209 |
      210 |     it('should reject oversized payloads', async () => {

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:207:34)

  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should warn about invalid User-Agent headers

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Security Warning: Missing or empty User-Agent header."

    Number of calls: 0

      217 |     it('should warn about invalid User-Agent headers', async () => {
      218 |       await request(app).get('/test').set('User-Agent', '');
    > 219 |       expect(consoleWarnSpy).toHaveBeenCalledWith('Security Warning: Missing or empty User-Agent heade
r.');
          |                              ^
      220 |     });
      221 |
      222 |     it('should warn about oversized User-Agent headers', async () => {

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:219:30)

  ‚óè Security Middleware ‚Ä∫ Security Validation ‚Ä∫ should warn about oversized User-Agent headers

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Security Warning: Oversized User-Agent header: 300 chars"

    Number of calls: 0

      222 |     it('should warn about oversized User-Agent headers', async () => {
      223 |       await request(app).get('/test').set('User-Agent', 'a'.repeat(300));
    > 224 |       expect(consoleWarnSpy).toHaveBeenCalledWith('Security Warning: Oversized User-Agent header: 300 
chars');
          |                              ^
      225 |     });
      226 |   });
      227 |

      at Object.<anonymous> (src/middleware/__tests__/security.test.ts:224:30)

 FAIL  src/services/__tests__/api-key-service.test.ts
  ‚óè ApiKeyService ‚Ä∫ validateApiKey ‚Ä∫ should reject non-existent API key

    expect(received).toBe(expected) // Object.is equality

    Expected: "API key not found"
    Received: "Invalid API key format"

      135 |
      136 |       expect(result.isValid).toBe(false);
    > 137 |       expect(result.errorReason).toBe('API key not found');
          |                                  ^
      138 |     });
      139 |
      140 |     it('should reject revoked API key', async () => {

      at Object.<anonymous> (src/services/__tests__/api-key-service.test.ts:137:34)

 FAIL  src/tools/__tests__/form-sharing-tool.test.ts
  ‚óè FormSharingTool ‚Ä∫ updatePublicationSettings ‚Ä∫ should update publication settings successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      "form-123",
      Object {
    -   "maxSubmissions": 100,
        "password": "newpassword",
        "visibility": "private",
      },

    Number of calls: 1

      310 |
      311 |       // Assert
    > 312 |       expect(mockPublicationService.updatePublicationSettings).toHaveBeenCalledWith('form-123', input.
settings);
          |                                                                ^
      313 |       expect(result).toEqual({
      314 |         success: true,
      315 |         data: updatedSettings,

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:312:64)

  ‚óè FormSharingTool ‚Ä∫ updatePublicationSettings ‚Ä∫ should filter out undefined values from settings

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      "form-123",
      Object {
    -   "maxSubmissions": 100,
        "visibility": "private",
      },

    Number of calls: 1

      336 |
      337 |       // Assert
    > 338 |       expect(mockPublicationService.updatePublicationSettings).toHaveBeenCalledWith('form-123', {
          |                                                                ^
      339 |         visibility: FormVisibility.PRIVATE,
      340 |         maxSubmissions: 100
      341 |       });

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:338:64)

  ‚óè FormSharingTool ‚Ä∫ generateShareLink ‚Ä∫ should generate share link successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "form-123", {"customSlug": "my-form", "type": undefined}

    Number of calls: 0

      449 |
      450 |       // Assert
    > 451 |       expect(mockPublicationService.generateShareLink).toHaveBeenCalledWith('form-123', {
          |                                                        ^
      452 |         type: ShareLinkType.DIRECT,
      453 |         customSlug: 'my-form'
      454 |       });

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:451:56)

  ‚óè FormSharingTool ‚Ä∫ generateShareLink ‚Ä∫ should generate share link with security options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "form-123", {"expirationHours": 24, "maxUses": 100, "password": "secret", "trackingEnabled": true, "
type": undefined}

    Number of calls: 0

      478 |
      479 |       // Assert
    > 480 |       expect(mockPublicationService.generateShareLink).toHaveBeenCalledWith('form-123', {
          |                                                        ^
      481 |         type: ShareLinkType.SECURE,
      482 |         password: 'secret',
      483 |         expirationHours: 24,

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:480:56)

  ‚óè FormSharingTool ‚Ä∫ generateShareLink ‚Ä∫ should handle share link generation errors

    expect(received).toEqual(expected) // deep equality

    - Expected  -  1
    + Received  + 11

      Object {
    -   "error": "Link generation failed",
    +   "error": "[
    +   {
    +     \"expected\": \"'standard' | 'embed' | 'qr_code' | 'social'\",
    +     \"received\": \"undefined\",
    +     \"code\": \"invalid_type\",
    +     \"path\": [
    +       \"type\"
    +     ],
    +     \"message\": \"Required\"
    +   }
    + ]",
        "message": "Failed to generate share link",
        "success": false,
      }

      498 |
      499 |       // Assert
    > 500 |       expect(result).toEqual({
          |                      ^
      501 |         success: false,
      502 |         error: 'Link generation failed',
      503 |         message: 'Failed to generate share link'

      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:500:22)

  ‚óè FormSharingTool ‚Ä∫ edge cases and error handling ‚Ä∫ should handle empty form IDs array in bulk operation

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"error": "[
      {
        \"code\": \"too_small\",
        \"minimum\": 1,
        \"type\": \"array\",
        \"inclusive\": true,
        \"exact\": false,
        \"message\": \"Array must contain at least 1 element(s)\",
        \"path\": [
          \"formIds\"
        ]
      }
    ]", "message": "Failed to perform bulk operation", "success": false}

      828 |       // Act & Assert
      829 |       // The zod schema should throw a validation error for empty array
    > 830 |       await expect(formSharingTool.performBulkOperation(input)).rejects.toThrow();
          |             ^
      831 |     });
      832 |
      833 |     it('should handle invalid email in notification emails', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:830:13)

  ‚óè FormSharingTool ‚Ä∫ edge cases and error handling ‚Ä∫ should handle invalid email in notification emails

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"error": "[
      {
        \"validation\": \"email\",
        \"code\": \"invalid_string\",
        \"message\": \"Invalid email\",
        \"path\": [
          \"notificationEmails\",
          0
        ]
      }
    ]", "message": "Failed to publish form", "success": false}

      840 |       // Act & Assert
      841 |       // The zod schema should throw a validation error for invalid email
    > 842 |       await expect(formSharingTool.publishForm(input)).rejects.toThrow();
          |             ^
      843 |     });
      844 |
      845 |     it('should handle invalid datetime in publish date', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:842:13)

  ‚óè FormSharingTool ‚Ä∫ edge cases and error handling ‚Ä∫ should handle invalid datetime in publish date

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"error": "[
      {
        \"code\": \"invalid_string\",
        \"validation\": \"datetime\",
        \"message\": \"Invalid datetime\",
        \"path\": [
          \"publishDate\"
        ]
      }
    ]", "message": "Failed to publish form", "success": false}

      852 |       // Act & Assert
      853 |       // The zod schema should throw a validation error for invalid datetime
    > 854 |       await expect(formSharingTool.publishForm(input)).rejects.toThrow();
          |             ^
      855 |     });
      856 |   });
      857 | }); 

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/tools/__tests__/form-sharing-tool.test.ts:854:13)

 FAIL  src/validation/__tests__/schema-validator.test.ts
  ‚óè SchemaValidator ‚Ä∫ schema depth validation ‚Ä∫ should error when schema exceeds max depth

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      347 |       const result = validator.validateSchema(deepSchema);
      348 |
    > 349 |       expect(result.valid).toBe(false);
          |                            ^
      350 |       expect(result.errors.some(e => e.code === 'SCHEMA_DEPTH_EXCEEDED')).toBe(true);
      351 |     });
      352 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:349:28)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ string schema validation ‚Ä∫ should error for negative maxLength

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      412 |         const result = validator.validateSchema(schema);
      413 |
    > 414 |         expect(result.valid).toBe(false);
          |                              ^
      415 |         expect(result.errors.some(e => e.code === 'STRING_MAX_LENGTH_NEGATIVE')).toBe(true);
      416 |       });
      417 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:414:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ numeric schema validation ‚Ä∫ should error when exclusiveMinimum >=
 exclusiveMaximum

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      466 |         const result = validator.validateSchema(schema);
      467 |
    > 468 |         expect(result.valid).toBe(false);
          |                              ^
      469 |         expect(result.errors.some(e => e.code === 'NUMERIC_EXCLUSIVE_RANGE_CONFLICT')).toBe(true);
      470 |       });
      471 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:468:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ numeric schema validation ‚Ä∫ should error for negative multipleOf

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      479 |
      480 |         expect(result.valid).toBe(false);
    > 481 |         expect(result.errors.some(e => e.code === 'MULTIPLE_OF_NOT_POSITIVE')).toBe(true);
          |                                                                                ^
      482 |       });
      483 |
      484 |       it('should validate valid numeric constraints', () => {

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:481:80)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ object schema validation ‚Ä∫ should error for negative minPropertie
s

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      505 |         const result = validator.validateSchema(schema);
      506 |
    > 507 |         expect(result.valid).toBe(false);
          |                              ^
      508 |         expect(result.errors.some(e => e.code === 'OBJECT_MIN_PROPERTIES_NEGATIVE')).toBe(true);
      509 |       });
      510 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:507:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ object schema validation ‚Ä∫ should error for negative maxPropertie
s

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      517 |         const result = validator.validateSchema(schema);
      518 |
    > 519 |         expect(result.valid).toBe(false);
          |                              ^
      520 |         expect(result.errors.some(e => e.code === 'OBJECT_MAX_PROPERTIES_NEGATIVE')).toBe(true);
      521 |       });
      522 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:519:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ array schema validation ‚Ä∫ should error for negative minItems

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      544 |         const result = validator.validateSchema(schema);
      545 |
    > 546 |         expect(result.valid).toBe(false);
          |                              ^
      547 |         expect(result.errors.some(e => e.code === 'ARRAY_MIN_ITEMS_NEGATIVE')).toBe(true);
      548 |       });
      549 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:546:30)

  ‚óè SchemaValidator ‚Ä∫ type-specific validation ‚Ä∫ array schema validation ‚Ä∫ should error for negative maxItems

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      556 |         const result = validator.validateSchema(schema);
      557 |
    > 558 |         expect(result.valid).toBe(false);
          |                              ^
      559 |         expect(result.errors.some(e => e.code === 'ARRAY_MAX_ITEMS_NEGATIVE')).toBe(true);
      560 |       });
      561 |

      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:558:30)

  ‚óè SchemaValidator ‚Ä∫ edge cases ‚Ä∫ should handle null schema

    TypeError: Cannot read properties of null (reading 'type')

      78 |   ): void {
      79 |     // Check if type is specified
    > 80 |     if (!schema.type && this.config.strict) {
         |                 ^
      81 |       errors.push({
      82 |         code: 'SCHEMA_TYPE_MISSING',
      83 |         message: 'Schema must specify a type property',

      at SchemaValidator.type [as validateBasicStructure] (src/validation/schema-validator.ts:80:17)
      at SchemaValidator.validateBasicStructure [as validateSchema] (src/validation/schema-validator.ts:43:10)
      at Object.<anonymous> (src/validation/__tests__/schema-validator.test.ts:589:32)

 FAIL  src/tools/__tests__/team-manager.test.ts
  ‚óè TeamManager ‚Ä∫ updateTeam ‚Ä∫ should handle setting parentTeamId to undefined

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "team-123", undefined

    Number of calls: 0

      209 |
      210 |       // Assert
    > 211 |       expect(validateSpy).toHaveBeenCalledWith('team-123', undefined);
          |                           ^
      212 |     });
      213 |   });
      214 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:211:27)

  ‚óè TeamManager ‚Ä∫ deleteTeam ‚Ä∫ should delete child teams when deleteChildTeams option is true

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

    - "child-team-1",
    + "team-123",
      {"deleteChildTeams": true},

    Number of calls: 1

      265 |
      266 |       // Assert
    > 267 |       expect(deleteSpy).toHaveBeenCalledWith('child-team-1', { deleteChildTeams: true });
          |                         ^
      268 |       expect(deleteSpy).toHaveBeenCalledWith('child-team-2', { deleteChildTeams: true });
      269 |     });
      270 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:267:25)

  ‚óè TeamManager ‚Ä∫ moveTeam ‚Ä∫ should move team to new parent

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "team-123", {"parentTeamId": "new-parent"}

    Number of calls: 0

      512 |       // Assert
      513 |       expect(validateSpy).toHaveBeenCalledWith('team-123', 'new-parent');
    > 514 |       expect(mockTeamService.updateTeam).toHaveBeenCalledWith('team-123', { parentTeamId: 'new-parent'
 });
          |                                          ^
      515 |       expect(result).toEqual(mockTeamResponse);
      516 |     });
      517 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:514:42)

  ‚óè TeamManager ‚Ä∫ moveTeam ‚Ä∫ should make team a root team when newParentTeamId is undefined

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "team-123", {"parentTeamId": undefined}

    Number of calls: 0

      526 |       // Assert
      527 |       expect(validateSpy).toHaveBeenCalledWith('team-123', undefined);
    > 528 |       expect(mockTeamService.updateTeam).toHaveBeenCalledWith('team-123', { parentTeamId: undefined })
;
          |                                          ^
      529 |     });
      530 |   });
      531 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:528:42)

  ‚óè TeamManager ‚Ä∫ edge cases and error handling ‚Ä∫ should handle team with no child teams in deleteTeam

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      579 |       const deleteSpy = jest.spyOn(teamManager, 'deleteTeam');
      580 |       // Should only be called once (for the main team, not recursively)
    > 581 |       expect(deleteSpy).toHaveBeenCalledTimes(1);
          |                         ^
      582 |     });
      583 |   });
      584 |

      at Object.<anonymous> (src/tools/__tests__/team-manager.test.ts:581:25)

 FAIL  src/__tests__/index.test.ts
  ‚óè Index.ts Entry Point ‚Ä∫ process error handlers ‚Ä∫ should handle unhandledRejection and exit

    Process exit called with code: 1

      64 |     // Spy on process.exit
      65 |     processExitSpy = jest.spyOn(process, 'exit').mockImplementation((code?: string | number | null | un
defined) => {
    > 66 |       throw new Error(`Process exit called with code: ${code}`);
         |             ^
      67 |     });
      68 |   });
      69 |

      at process.<anonymous> (src/__tests__/index.test.ts:66:13)
      at process.exit (src/index.ts:40:11)
      at Object.<anonymous> (src/__tests__/index.test.ts:202:17)

  ‚óè Index.ts Entry Point ‚Ä∫ process error handlers ‚Ä∫ should handle uncaughtException and exit

    Process exit called with code: 1

      64 |     // Spy on process.exit
      65 |     processExitSpy = jest.spyOn(process, 'exit').mockImplementation((code?: string | number | null | un
defined) => {
    > 66 |       throw new Error(`Process exit called with code: ${code}`);
         |             ^
      67 |     });
      68 |   });
      69 |

      at process.<anonymous> (src/__tests__/index.test.ts:66:13)
      at process.exit (src/index.ts:46:11)
      at Object.<anonymous> (src/__tests__/index.test.ts:216:17)


  ‚óè Test suite failed to run

    Test unhandled rejection

      196 |         require('../index');
      197 |         
    > 198 |         const testError = new Error('Test unhandled rejection');
          |                           ^
      199 |         const testPromise = Promise.reject(testError);
      200 |
      201 |         // Simulate the event

      at Object.<anonymous> (src/__tests__/index.test.ts:198:27)

 FAIL  src/__tests__/worker.test.ts
  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should handle preflight (OPTIONS) requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 204
    Received: 200

      468 |
      469 |       const response = await worker.default.fetch(request, mockEnv);
    > 470 |       expect(response.status).toBe(204);
          |                               ^
      471 |       expect(response.headers.get('Access-Control-Allow-Origin')).toBe('*');
      472 |       expect(response.headers.get('Access-Control-Allow-Methods')).toContain('POST');
      473 |     });

      at Object.<anonymous> (src/__tests__/worker.test.ts:470:31)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should reject unauthorized MCP requests

    expect(received).toBe(expected) // Object.is equality

    Expected: "Unauthorized"
    Received: undefined

      483 |       expect(response.status).toBe(401);
      484 |       const json = await response.json();
    > 485 |       expect(json.error.message).toBe('Unauthorized');
          |                                  ^
      486 |     });
      487 |
      488 |     it('should process a valid MCP request with API key in header', async () => {

      at Object.<anonymous> (src/__tests__/worker.test.ts:485:34)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should process a valid MCP request with API key in 
header

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      498 |   
      499 |         const response = await worker.default.fetch(request, mockEnv);
    > 500 |         expect(response.status).toBe(200);
          |                                 ^
      501 |         const json = await response.json();
      502 |         expect(json.id).toBe(1);
      503 |         expect(json.result.capabilities.protocolVersion).toBe('1.0.0');

      at Object.<anonymous> (src/__tests__/worker.test.ts:500:33)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should process a valid MCP request with API key in 
query param (for authless transport)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      513 |   
      514 |         const response = await worker.default.fetch(request, mockEnv);
    > 515 |         expect(response.status).toBe(200);
          |                                 ^
      516 |         const json = await response.json();
      517 |         expect(json.id).toBe(2);
      518 |         expect(json.result.capabilities).toBeDefined();

      at Object.<anonymous> (src/__tests__/worker.test.ts:515:33)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should handle SSE connection requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      526 |   
      527 |         const response = await worker.default.fetch(request, mockEnv);
    > 528 |         expect(response.status).toBe(200);
          |                                 ^
      529 |         expect(response.headers.get('Content-Type')).toBe('text/event-stream; charset=utf-8');
      530 |     });
      531 |

      at Object.<anonymous> (src/__tests__/worker.test.ts:528:33)

  ‚óè Cloudflare Worker Components ‚Ä∫ Main Worker Fetch Handler ‚Ä∫ should reject SSE connection without API key

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 404

      537 |   
      538 |         const response = await worker.default.fetch(request, mockEnv);
    > 539 |         expect(response.status).toBe(401);
          |                                 ^
      540 |     });
      541 |
      542 |     it('should return 404 for unknown paths', async () => {

      at Object.<anonymous> (src/__tests__/worker.test.ts:539:33)

 FAIL  src/middleware/__tests__/api-key-auth.test.ts
  ‚óè API Key Authentication Middleware ‚Ä∫ apiKeyAuth ‚Ä∫ should return 429 if usage limit is exceeded

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 429
    Received: 401

    Number of calls: 1

      155 |       
      156 |         expect(nextFunction).not.toHaveBeenCalled();
    > 157 |         expect(statusSpy).toHaveBeenCalledWith(429);
          |                           ^
      158 |         expect(jsonSpy).toHaveBeenCalledWith(expect.objectContaining({
      159 |           code: 'USAGE_LIMIT_EXCEEDED',
      160 |           message: 'API key usage limit exceeded',

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:157:27)

  ‚óè API Key Authentication Middleware ‚Ä∫ Scope Requirement Helpers ‚Ä∫ requireScopes should succeed with adequate sco
pes

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      276 |     it('requireScopes should succeed with adequate scopes', async () => {
      277 |       await requireScopes([ApiKeyScope.FORMS_READ])(mockRequest as Request, mockResponse as Response, 
nextFunction);
    > 278 |       expect(nextFunction).toHaveBeenCalled();
          |                            ^
      279 |     });
      280 |   
      281 |     it('requireReadAccess should succeed with READ scope', async () => {

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:278:28)

  ‚óè API Key Authentication Middleware ‚Ä∫ Scope Requirement Helpers ‚Ä∫ requireReadAccess should succeed with READ sco
pe

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      295 |         mockedApiKeyService.validateApiKey.mockResolvedValue(readValidationResult);
      296 |         await requireReadAccess()(mockRequest as Request, mockResponse as Response, nextFunction);
    > 297 |         expect(nextFunction).toHaveBeenCalled();
          |                              ^
      298 |     });
      299 |
      300 |     it('requireWriteAccess should fail without WRITE scopes', async () => {

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:297:30)

  ‚óè API Key Authentication Middleware ‚Ä∫ Scope Requirement Helpers ‚Ä∫ requireAdminAccess should succeed with ADMIN s
cope

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      333 |         mockedApiKeyService.validateApiKey.mockResolvedValue(adminValidationResult);
      334 |         await requireAdminAccess()(mockRequest as Request, mockResponse as Response, nextFunction);
    > 335 |         expect(nextFunction).toHaveBeenCalled();
          |                              ^
      336 |     });
      337 |   });
      338 |

      at Object.<anonymous> (src/middleware/__tests__/api-key-auth.test.ts:335:30)

 FAIL  src/__tests__/api/TallyApiClient.test.ts
  ‚óè TallyApiClient ‚Ä∫ Request Handling ‚Ä∫ should handle a 404 Not Found error

    expect(received).rejects.toThrow(expected)

    Expected substring: "Not Found"

    Received function did not throw

      88 |       client = new TallyApiClient({ accessToken: env.TALLY_API_KEY });
      89 |       
    > 90 |       await expect(client.get('/non-existent-endpoint')).rejects.toThrow('Not Found');
         |                                                                  ^
      91 |     });
      92 |
      93 |     it('should handle a 401 Unauthorized error', async () => {

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:90:66)

  ‚óè TallyApiClient ‚Ä∫ Request Handling ‚Ä∫ should handle a 401 Unauthorized error

    expect(received).rejects.toThrow(expected)

    Expected substring: "No valid authentication found. Please authenticate first."
    Received message:   "this.axiosInstance.request is not a function"

          586 |
          587 |     // The interceptors will handle authentication and error handling
        > 588 |     const response: AxiosResponse<T> = await this.axiosInstance.request(requestConfig);
              |                                                                 ^
          589 |
          590 |     return {
          591 |       data: response.data,

          at TallyApiClient.request (src/services/TallyApiClient.ts:588:65)
          at TallyApiClient.request [as get] (src/services/TallyApiClient.ts:348:17)
          at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:96:27)

      94 |       mockedCreate.mockReturnValue({ defaults: { headers: { common: {} } }, interceptors: { request: { 
use: jest.fn() }, response: { use: jest.fn() } } });
      95 |       client = new TallyApiClient(); // No access token
    > 96 |       await expect(client.get('/me')).rejects.toThrow('No valid authentication found. Please authentica
te first.');
         |                                               ^
      97 |     });
      98 |   });
      99 | }); 

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:96:47)


  ‚óè Test suite failed to run

    thrown: Object {
      "isAxiosError": true,
      "response": Object {
        "data": Object {
          "message": "Not Found",
        },
        "status": 404,
      },
    }

      at _getError (node_modules/jest-circus/build/utils.js:432:18)
          at Array.map (<anonymous>)

  ‚óè Test suite failed to run

    NotFoundError: Not Found

      289 |     
      290 |     case 404:
    > 291 |       return new NotFoundError(message, statusCode, statusText, headers, originalError);
          |              ^
      292 |     
      293 |     case 429:
      294 |       return new RateLimitError(message, statusCode, statusText, headers, originalError);

      at createErrorFromResponse (src/models/errors.ts:291:14)
      at TallyApiClient.handleResponseError (src/services/TallyApiClient.ts:876:54)
      at handleResponseError (src/services/TallyApiClient.ts:999:21)
      at Object.mockInterceptor [as use] (src/__tests__/api/TallyApiClient.test.ts:85:57)
      at TallyApiClient.use [as setupInterceptors] (src/services/TallyApiClient.ts:987:46)
      at new setupInterceptors (src/services/TallyApiClient.ts:220:10)
      at Object.<anonymous> (src/__tests__/api/TallyApiClient.test.ts:88:16)

 FAIL  src/validation/__tests__/validation-utils.test.ts
  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should format simple path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      51 |   describe('formatPath', () => {
      52 |     it('should format simple path', () => {
    > 53 |       const formatted = ValidationUtils.formatPath(['root', 'child']);
         |                                         ^
      54 |       expect(formatted).toBe('root.child');
      55 |     });
      56 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:53:41)

  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should format array index path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      56 |
      57 |     it('should format array index path', () => {
    > 58 |       const formatted = ValidationUtils.formatPath(['root', '0', 'child']);
         |                                         ^
      59 |       expect(formatted).toBe('root[0].child');
      60 |     });
      61 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:58:41)

  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should handle empty path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      61 |
      62 |     it('should handle empty path', () => {
    > 63 |       const formatted = ValidationUtils.formatPath([]);
         |                                         ^
      64 |       expect(formatted).toBe('');
      65 |     });
      66 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:63:41)

  ‚óè ValidationUtils ‚Ä∫ formatPath ‚Ä∫ should handle single element path

    TypeError: validation_utils_1.ValidationUtils.formatPath is not a function

      66 |
      67 |     it('should handle single element path', () => {
    > 68 |       const formatted = ValidationUtils.formatPath(['root']);
         |                                         ^
      69 |       expect(formatted).toBe('root');
      70 |     });
      71 |   });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:68:41)

  ‚óè ValidationUtils ‚Ä∫ isValidJsonSchemaType ‚Ä∫ should return true for valid types

    TypeError: validation_utils_1.ValidationUtils.isValidJsonSchemaType is not a function

      76 |       
      77 |       validTypes.forEach(type => {
    > 78 |         expect(ValidationUtils.isValidJsonSchemaType(type)).toBe(true);
         |                                ^
      79 |       });
      80 |     });
      81 |

      at src/validation/__tests__/validation-utils.test.ts:78:32
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:77:18)

  ‚óè ValidationUtils ‚Ä∫ isValidJsonSchemaType ‚Ä∫ should return false for invalid types

    TypeError: validation_utils_1.ValidationUtils.isValidJsonSchemaType is not a function

      84 |       
      85 |       invalidTypes.forEach(type => {
    > 86 |         expect(ValidationUtils.isValidJsonSchemaType(type)).toBe(false);
         |                                ^
      87 |       });
      88 |     });
      89 |

      at src/validation/__tests__/validation-utils.test.ts:86:32
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:85:20)

  ‚óè ValidationUtils ‚Ä∫ isValidJsonSchemaType ‚Ä∫ should handle null and undefined

    TypeError: validation_utils_1.ValidationUtils.isValidJsonSchemaType is not a function

      89 |
      90 |     it('should handle null and undefined', () => {
    > 91 |       expect(ValidationUtils.isValidJsonSchemaType(null as any)).toBe(false);
         |                              ^
      92 |       expect(ValidationUtils.isValidJsonSchemaType(undefined as any)).toBe(false);
      93 |     });
      94 |   });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:91:30)

  ‚óè ValidationUtils ‚Ä∫ mergeValidationResults ‚Ä∫ should merge two validation results

    TypeError: validation_utils_1.ValidationUtils.mergeValidationResults is not a function

      112 |       };
      113 |
    > 114 |       const merged = ValidationUtils.mergeValidationResults(result1, result2);
          |                                      ^
      115 |
      116 |       expect(merged.valid).toBe(false); // Should be false if any result is invalid
      117 |       expect(merged.errors).toHaveLength(1);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:114:38)

  ‚óè ValidationUtils ‚Ä∫ mergeValidationResults ‚Ä∫ should handle empty results

    TypeError: validation_utils_1.ValidationUtils.mergeValidationResults is not a function

      134 |       };
      135 |
    > 136 |       const merged = ValidationUtils.mergeValidationResults(emptyResult, emptyResult);
          |                                      ^
      137 |
      138 |       expect(merged.valid).toBe(true);
      139 |       expect(merged.errors).toHaveLength(0);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:136:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should validate required fields are present

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      153 |       const required = ['name', 'age'];
      154 |
    > 155 |       const errors = ValidationUtils.validateRequired(data, required);
          |                                      ^
      156 |
      157 |       expect(errors).toHaveLength(0);
      158 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:155:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should return errors for missing required fields

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      162 |       const required = ['name', 'age', 'email'];
      163 |
    > 164 |       const errors = ValidationUtils.validateRequired(data, required);
          |                                      ^
      165 |
      166 |       expect(errors).toHaveLength(2);
      167 |       expect(errors[0].code).toBe('REQUIRED_FIELD_MISSING');

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:164:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should handle empty required array

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      175 |       const required: string[] = [];
      176 |
    > 177 |       const errors = ValidationUtils.validateRequired(data, required);
          |                                      ^
      178 |
      179 |       expect(errors).toHaveLength(0);
      180 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:177:38)

  ‚óè ValidationUtils ‚Ä∫ validateRequired ‚Ä∫ should handle null/undefined data

    TypeError: validation_utils_1.ValidationUtils.validateRequired is not a function

      183 |       const required = ['name'];
      184 |
    > 185 |       const errorsNull = ValidationUtils.validateRequired(null, required);
          |                                          ^
      186 |       const errorsUndefined = ValidationUtils.validateRequired(undefined, required);
      187 |
      188 |       expect(errorsNull).toHaveLength(1);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:185:42)

  ‚óè ValidationUtils ‚Ä∫ sanitizeErrorMessage ‚Ä∫ should sanitize error messages

    TypeError: validation_utils_1.ValidationUtils.sanitizeErrorMessage is not a function

      194 |     it('should sanitize error messages', () => {
      195 |       const message = 'Error with <script>alert("xss")</script> content';
    > 196 |       const sanitized = ValidationUtils.sanitizeErrorMessage(message);
          |                                         ^
      197 |
      198 |       expect(sanitized).not.toContain('<script>');
      199 |       expect(sanitized).not.toContain('alert');

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:196:41)

  ‚óè ValidationUtils ‚Ä∫ sanitizeErrorMessage ‚Ä∫ should preserve safe content

    TypeError: validation_utils_1.ValidationUtils.sanitizeErrorMessage is not a function

      202 |     it('should preserve safe content', () => {
      203 |       const message = 'Simple error message with numbers 123 and symbols !@#';
    > 204 |       const sanitized = ValidationUtils.sanitizeErrorMessage(message);
          |                                         ^
      205 |
      206 |       expect(sanitized).toBe(message);
      207 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:204:41)

  ‚óè ValidationUtils ‚Ä∫ sanitizeErrorMessage ‚Ä∫ should handle empty and null messages

    TypeError: validation_utils_1.ValidationUtils.sanitizeErrorMessage is not a function

      208 |
      209 |     it('should handle empty and null messages', () => {
    > 210 |       expect(ValidationUtils.sanitizeErrorMessage('')).toBe('');
          |                              ^
      211 |       expect(ValidationUtils.sanitizeErrorMessage(null as any)).toBe('');
      212 |       expect(ValidationUtils.sanitizeErrorMessage(undefined as any)).toBe('');
      213 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:210:30)

  ‚óè ValidationUtils ‚Ä∫ getErrorSeverityLevel ‚Ä∫ should return correct numeric levels for severities

    TypeError: validation_utils_1.ValidationUtils.getErrorSeverityLevel is not a function

      216 |   describe('getErrorSeverityLevel', () => {
      217 |     it('should return correct numeric levels for severities', () => {
    > 218 |       expect(ValidationUtils.getErrorSeverityLevel(ValidationSeverity.ERROR)).toBe(3);
          |                              ^
      219 |       expect(ValidationUtils.getErrorSeverityLevel(ValidationSeverity.WARNING)).toBe(2);
      220 |       expect(ValidationUtils.getErrorSeverityLevel(ValidationSeverity.INFO)).toBe(1);
      221 |     });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:218:30)

  ‚óè ValidationUtils ‚Ä∫ getErrorSeverityLevel ‚Ä∫ should handle invalid severity

    TypeError: validation_utils_1.ValidationUtils.getErrorSeverityLevel is not a function

      222 |
      223 |     it('should handle invalid severity', () => {
    > 224 |       expect(ValidationUtils.getErrorSeverityLevel('invalid' as any)).toBe(0);
          |                              ^
      225 |     });
      226 |   });
      227 |

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:224:30)

  ‚óè ValidationUtils ‚Ä∫ sortErrorsBySeverity ‚Ä∫ should sort errors by severity (highest first)

    TypeError: validation_utils_1.ValidationUtils.sortErrorsBySeverity is not a function

      235 |       ];
      236 |
    > 237 |       const sorted = ValidationUtils.sortErrorsBySeverity(errors);
          |                                      ^
      238 |
      239 |       expect(sorted[0].severity).toBe(ValidationSeverity.ERROR);
      240 |       expect(sorted[1].severity).toBe(ValidationSeverity.ERROR);

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:237:38)

  ‚óè ValidationUtils ‚Ä∫ sortErrorsBySeverity ‚Ä∫ should handle empty array

    TypeError: validation_utils_1.ValidationUtils.sortErrorsBySeverity is not a function

      244 |
      245 |     it('should handle empty array', () => {
    > 246 |       const sorted = ValidationUtils.sortErrorsBySeverity([]);
          |                                      ^
      247 |       expect(sorted).toHaveLength(0);
      248 |     });
      249 |   });

      at Object.<anonymous> (src/validation/__tests__/validation-utils.test.ts:246:38)

 FAIL  src/validation/__tests__/validation-utils-simple.test.ts
  ‚óè ValidationUtils ‚Ä∫ calculateComplexity ‚Ä∫ should calculate complexity for object schema

    expect(received).toBe(expected) // Object.is equality

    Expected: 4
    Received: 5.5

      174 |
      175 |       expect(complexity).toBeGreaterThan(1);
    > 176 |       expect(complexity).toBe(4); // 1 base + 3 properties
          |                          ^
      177 |     });
      178 |
      179 |     it('should calculate complexity for nested schema', () => {

      at Object.<anonymous> (src/validation/__tests__/validation-utils-simple.test.ts:176:26)

 FAIL  src/utils/__tests__/config.test.ts
  ‚óè Application Configuration ‚Ä∫ should use default values for optional variables

    expect(received).toBe(expected) // Object.is equality

    Expected: "development"
    Received: "test"

      42 |     expect(reloadedConfig.tally.apiBaseUrl).toBe('https://api.tally.so/v1');
      43 |     expect(reloadedConfig.server.port).toBe(3000);
    > 44 |     expect(reloadedConfig.development.nodeEnv).toBe('development');
         |                                                ^
      45 |     expect(reloadedConfig.development.debug).toBe(false);
      46 |   });
      47 |

      at Object.<anonymous> (src/utils/__tests__/config.test.ts:44:48)

  ‚óè Application Configuration ‚Ä∫ should throw an error if a required environment variable is missing

    expect(received).toThrow(expected)

    Expected substring: "Required environment variable TALLY_API_KEY is not set"

    Received function did not throw

      51 |     delete process.env.TALLY_API_KEY;
      52 |     
    > 53 |     expect(() => require('../config')).toThrow('Required environment variable TALLY_API_KEY is not set'
);
         |                                        ^
      54 |   });
      55 |
      56 |   it('should throw an error for non-numeric number variables', () => {

      at Object.<anonymous> (src/utils/__tests__/config.test.ts:53:40)

  ‚óè Application Configuration ‚Ä∫ validateConfig ‚Ä∫ should log an error and exit if required config is missing

    Required environment variable JWT_SECRET is not set

      51 |   const value = process.env[name];
      52 |   if (!value) {
    > 53 |     throw new Error(`Required environment variable ${name} is not set`);
         |           ^
      54 |   }
      55 |   return value;
      56 | }

      at getRequiredEnvVar (src/utils/config.ts:53:11)
      at Object.getRequiredEnvVar (src/utils/config.ts:108:16)
      at Object.<anonymous> (src/utils/__tests__/config.test.ts:101:54)

 FAIL  src/__tests__/utils/capability-negotiation.test.ts
  ‚óè capability-negotiation ‚Ä∫ negotiateCapabilities ‚Ä∫ should handle partial client capabilities

    expect(received).toEqual(expected) // deep equality

    Expected: {"get": true, "list": true, "listChanged": true, "subscribe": true}
    Received: undefined

      142 |
      143 |       // Prompts and logging should inherit server defaults
    > 144 |       expect(result.prompts).toEqual(DEFAULT_SERVER_CAPABILITIES.prompts);
          |                              ^
      145 |       expect(result.logging).toEqual(DEFAULT_SERVER_CAPABILITIES.logging);
      146 |     });
      147 |

      at Object.<anonymous> (src/__tests__/utils/capability-negotiation.test.ts:144:30)

 FAIL  src/utils/__tests__/capability-negotiation.test.ts
  ‚óè Capability Negotiation ‚Ä∫ negotiateCapabilities ‚Ä∫ should successfully negotiate capabilities when versions matc
h

    expect(received).toEqual(expected) // deep equality

    Expected: {"delete": true, "get": true, "listChanged": true, "put": true, "subscribe": true}
    Received: undefined

      47 |
      48 |       // Check resources (client didn't specify, should be server default)
    > 49 |       expect(negotiated.resources).toEqual(DEFAULT_SERVER_CAPABILITIES.resources);
         |                                    ^
      50 |     });
      51 |
      52 |     it('should use server default when a client capability is not specified', () => {

      at Object.<anonymous> (src/utils/__tests__/capability-negotiation.test.ts:49:36)


Test Suites: 21 failed, 30 passed, 51 total
Tests:       92 failed, 741 passed, 833 total
Snapshots:   0 total
Time:        80.067 s
Ran all test suites.

Jest has detected the following 2 open handles potentially keeping Jest from exiting:

  ‚óè  TCPSERVERWRAP

      1261 |
      1262 |         // Set up error handler BEFORE calling listen
    > 1263 |         this.server = this.app.listen(this.config.port, this.config.host);
           |                                ^
      1264 |         
      1265 |         this.server.on('error', (error: any) => {
      1266 |           this.log('error', 'HTTP server error:', undefined, error as Error);

      at Function.listen (node_modules/express/lib/application.js:605:24)
      at listen (src/server.ts:1263:32)
      at MCPServer.startHttpServer (src/server.ts:1241:12)
      at MCPServer.startHttpServer (src/server.ts:585:18)
      at Object.<anonymous> (src/__tests__/error-handling-logging.test.ts:44:14)


  ‚óè  Timeout

      49 |       }, timeout);
      50 |
    > 51 |       this.eventSource = new EventSource(`${this.serverUrl}?clientId=${this.clientId}`);
         |                          ^
      52 |
      53 |       this.eventSource.onopen = () => {
      54 |         this.connected = true;

      at connect (node_modules/eventsource/lib/eventsource.js:146:37)
      at new EventSource (node_modules/eventsource/lib/eventsource.js:283:3)
      at src/__tests__/sse-connection-handshake.test.ts:51:26
      at MockMCPClient.connect (src/__tests__/sse-connection-handshake.test.ts:45:12)
      at Object.<anonymous> (src/__tests__/sse-connection-handshake.test.ts:279:20)


```

---



---

_**User**_

I believe you may be having trouble processing the output of these tests. Is it possible that it's just too much to review all at once? If so, please process in batches that you can handle.

---

_**Assistant**_

You're absolutely right! The test output is quite extensive and I should process it in manageable batches. Let me break this down systematically.

---

